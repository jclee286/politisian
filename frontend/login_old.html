<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="unsafe-none">
    <title>ì •ì¹˜ì¸ ê´€ë¦¬ ì‹œìŠ¤í…œ - ë¡œê·¸ì¸</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 500px; 
            margin: 50px auto; 
            padding: 20px; 
            text-align: center;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background: #e3f2fd;
            border: 1px solid #90caf9;
            color: #1565c0;
            font-size: 14px;
        }
        .status.error {
            background: #ffebee;
            border-color: #ef9a9a;
            color: #c62828;
        }
        .status.success {
            background: #e8f5e8;
            border-color: #a5d6a7;
            color: #2e7d32;
        }
        .debug {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            text-align: left;
            color: #666;
            max-height: 200px;
            overflow-y: auto;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .google { background: #4285f4; color: white; }
        .facebook { background: #1877f2; color: white; }
        .twitter { background: #1da1f2; color: white; }
        .discord { background: #5865f2; color: white; }
        .github { background: #333; color: white; }
        .user-info {
            margin-top: 30px;
            padding: 20px;
            background: #e8f5e8;
            border-radius: 8px;
            display: none;
            text-align: left;
        }
        .logout-btn {
            background: #dc3545;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: 600;
        }
        .hidden { display: none; }
        #debugLog { 
            margin-top: 20px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›ï¸ ì •ì¹˜ì¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
        <p class="subtitle">ì†Œì…œ ê³„ì •ìœ¼ë¡œ ê°„í¸í•˜ê²Œ ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
        
        <div id="status" class="status">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</div>
        
        <div id="login-buttons" class="hidden">
            <p>Web3Auth ëª¨ë‹¬ì´ ìë™ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤...</p>
            <button class="btn" onclick="retryLogin()" style="background: #6c757d; color: white;">ë‹¤ì‹œ ë¡œê·¸ì¸ ì‹œë„</button>
        </div>
        
        <div id="user-info" class="user-info">
            <h3>âœ… ë¡œê·¸ì¸ ì„±ê³µ!</h3>
            <div id="user-details"></div>
            <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        
        <div id="debugLog">
            <h4>ğŸ” ë””ë²„ê¹… ë¡œê·¸</h4>
            <div id="debugMessages" class="debug"></div>
        </div>
    </div>

    <!-- êµ¬ê¸€ OAuth ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        // êµ¬ê¸€ OAuth í´ë¼ì´ì–¸íŠ¸ ID (ë‚˜ì¤‘ì— ì„¤ì •)
        const GOOGLE_CLIENT_ID = "YOUR_GOOGLE_CLIENT_ID";
        
        // ë””ë²„ê¹… í•¨ìˆ˜ë“¤
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugMessages');
            const logMsg = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            
            logElement.innerHTML += logMsg + '\n';
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logMsg);
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            
            debugLog(`Status: ${message}`, type);
        }

        function showElement(id) {
            document.getElementById(id).classList.remove('hidden');
            debugLog(`Element shown: ${id}`);
        }

        function hideElement(id) {
            document.getElementById(id).classList.add('hidden');
            debugLog(`Element hidden: ${id}`);
        }

        // êµ¬ê¸€ ë¡œê·¸ì¸ ì´ˆê¸°í™”
        function initGoogleLogin() {
            debugLog('=== êµ¬ê¸€ ë¡œê·¸ì¸ ì´ˆê¸°í™” ì‹œì‘ ===');
            updateStatus('êµ¬ê¸€ ë¡œê·¸ì¸ ì¤€ë¹„ ì¤‘...');
            
            // êµ¬ê¸€ ë¡œê·¸ì¸ ë²„íŠ¼ í‘œì‹œ
            showElement('login-buttons');
        }

        // êµ¬ê¸€ ë¡œê·¸ì¸ ì²˜ë¦¬ í•¨ìˆ˜ (ì„ì‹œ)
        function handleGoogleLogin() {
            debugLog('=== êµ¬ê¸€ ë¡œê·¸ì¸ ì‹œì‘ ===');
            updateStatus('êµ¬ê¸€ ë¡œê·¸ì¸ ì¤‘...');
            
            // TODO: ì‹¤ì œ êµ¬ê¸€ OAuth êµ¬í˜„ ì˜ˆì •
            alert('êµ¬ê¸€ OAuth êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
        }
        
        // ìë™ ë¡œê·¸ì¸ í•¨ìˆ˜ (í˜ì´ì§€ ë¡œë“œì‹œ ëª¨ë‹¬ ìë™ ì—´ê¸°)
        async function autoLogin() {
            try {
                debugLog('=== ìë™ ë¡œê·¸ì¸ ì‹œì‘ ===');
                updateStatus('Web3Auth ëª¨ë‹¬ì„ ì—½ë‹ˆë‹¤...', 'info');
                
                if (!web3AuthInstance) {
                    throw new Error('Web3Authê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                }
                
                // ì´ë¯¸ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì¸ì§€ ì²´í¬
                if (web3AuthInstance.connected) {
                    debugLog('ì´ë¯¸ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ë°œê²¬');
                    const user = await web3AuthInstance.getUserInfo();
                    showUserInfo(user);
                    return;
                }
                
                debugLog('Web3Auth ëª¨ë‹¬ ì—´ê¸°...');
                await web3AuthInstance.connect();
                
                debugLog('ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°...');
                const user = await web3AuthInstance.getUserInfo();
                debugLog(`ì‚¬ìš©ì ì •ë³´: ${JSON.stringify(user, null, 2)}`);
                
                // Web3Auth ì§€ê°‘ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                debugLog('ì§€ê°‘ ì •ë³´ ê°€ì ¸ì˜¤ê¸°...');
                const provider = web3AuthInstance.provider;
                if (provider) {
                    // Ethereum ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°
                    const web3 = new Web3(provider);
                    const accounts = await web3.eth.getAccounts();
                    if (accounts.length > 0) {
                        user.walletAddress = accounts[0];
                        debugLog(`ì§€ê°‘ ì£¼ì†Œ: ${accounts[0]}`);
                    }
                } else {
                    debugLog('í”„ë¡œë°”ì´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
                }
                
                showUserInfo(user);
                
            } catch (error) {
                debugLog(`âŒ ìë™ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
                debugLog(`ì—ëŸ¬ ì´ë¦„: ${error.name}`, 'error');
                debugLog(`ì—ëŸ¬ ì½”ë“œ: ${error.code || 'N/A'}`, 'error');
                debugLog(`ì „ì²´ ì—ëŸ¬ ê°ì²´: ${JSON.stringify(error, Object.getOwnPropertyNames(error), 2)}`, 'error');
                
                // ì—ëŸ¬ íƒ€ì…ë³„ ë©”ì‹œì§€ ê°œì„ 
                let userMessage = '';
                if (error.message.includes('Dapp logo')) {
                    userMessage = 'ì•± ë¡œê³  ì„¤ì • ì˜¤ë¥˜ì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.';
                } else if (error.message.includes('Cross-Origin')) {
                    userMessage = 'ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ì¸í•œ ì˜¤ë¥˜ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                } else if (error.message.includes('localhost')) {
                    userMessage = 'ê°œë°œ í™˜ê²½ ê´€ë ¨ ê²½ê³ ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                } else if (error.message.includes('cancelled') || error.message.includes('canceled')) {
                    userMessage = 'ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.';
                } else {
                    userMessage = `ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`;
                }
                
                updateStatus(userMessage, 'error');
                showElement('login-buttons'); // ì¬ì‹œë„ ë²„íŠ¼ í‘œì‹œ
            }
        }
        
        // ìˆ˜ë™ ì¬ì‹œë„ í•¨ìˆ˜
        function retryLogin() {
            debugLog('ì‚¬ìš©ìê°€ ì¬ì‹œë„ ìš”ì²­');
            hideElement('login-buttons');
            autoLogin();
        }
        
        // ë¡œê·¸ì¸ í•¨ìˆ˜ (ê³µì‹ ë¬¸ì„œ ê¸°ë°˜) - ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
        async function login(provider) {
            try {
                debugLog(`=== ${provider} ë¡œê·¸ì¸ ì‹œì‘ ===`);
                updateStatus(`${provider} ë¡œê·¸ì¸ ì¤‘...`);
                
                if (!web3AuthInstance) {
                    throw new Error('Web3Authê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                }
                
                debugLog('connect() í˜¸ì¶œ ì¤‘...');
                await web3AuthInstance.connect();
                
                debugLog('getUserInfo() í˜¸ì¶œ ì¤‘...');
                const user = await web3AuthInstance.getUserInfo();
                debugLog(`ì‚¬ìš©ì ì •ë³´: ${JSON.stringify(user, null, 2)}`);
                
                showUserInfo(user);
                
            } catch (error) {
                debugLog(`âŒ ${provider} ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
                debugLog(`ì—ëŸ¬ ìŠ¤íƒ: ${error.stack}`, 'error');
                updateStatus(`${provider} ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        function showUserInfo(user) {
            debugLog('=== ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ===');
            
            const userDetails = document.getElementById('user-details');
            userDetails.innerHTML = `
                <p><strong>ì´ë¦„:</strong> ${user.name || 'N/A'}</p>
                <p><strong>ì´ë©”ì¼:</strong> ${user.email || 'N/A'}</p>
                <p><strong>ì‚¬ìš©ì ID:</strong> ${user.verifierId || 'N/A'}</p>
                <p><strong>ë¡œê·¸ì¸ ë°©ì‹:</strong> ${user.typeOfLogin || 'N/A'}</p>
            `;
            
            hideElement('login-buttons');
            showElement('user-info');
            updateStatus('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
            
            debugLog('ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì™„ë£Œ', 'success');
            
            // ë°±ì—”ë“œë¡œ ì „ì†¡
            sendUserDataToBackend(user);
        }
        
        async function sendUserDataToBackend(user) {
            try {
                debugLog('=== ë°±ì—”ë“œ ì „ì†¡ ì‹œì‘ ===');
                
                const userData = {
                    name: user.name,
                    email: user.email,
                    provider: user.typeOfLogin,
                    userId: user.verifierId,
                    profileImage: user.profileImage,
                    walletAddress: user.walletAddress
                };
                
                debugLog(`ì „ì†¡ ë°ì´í„°: ${JSON.stringify(userData, null, 2)}`);
                
                const response = await fetch('http://localhost:8080/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });
                
                debugLog(`ë°±ì—”ë“œ ì‘ë‹µ ìƒíƒœ: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    debugLog(`ë°±ì—”ë“œ ì‘ë‹µ: ${JSON.stringify(result, null, 2)}`, 'success');
                    
                    // ë¡œê·¸ì¸ ì„±ê³µ í›„ ë¦¬ë‹¤ì´ë ‰ì…˜
                    if (result.status === 'success') {
                        debugLog('ë¡œê·¸ì¸ ì„±ê³µ! ë¦¬ë‹¤ì´ë ‰ì…˜ ì¤€ë¹„ ì¤‘...', 'success');
                        
                        // 2ì´ˆ í›„ ë¦¬ë‹¤ì´ë ‰ì…˜ (ì‚¬ìš©ìê°€ ì„±ê³µ ë©”ì‹œì§€ë¥¼ ë³¼ ì‹œê°„ ì œê³µ)
                        setTimeout(() => {
                            if (result.isNewUser) {
                                debugLog('ì‹ ê·œ ì‚¬ìš©ì â†’ í”„ë¡œí•„ ì‘ì„± í˜ì´ì§€ë¡œ ì´ë™', 'info');
                                window.location.href = '/profile.html';
                            } else {
                                debugLog('ê¸°ì¡´ ì‚¬ìš©ì â†’ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™', 'info');
                                window.location.href = '/';
                            }
                        }, 2000);
                    }
                } else {
                    debugLog(`ë°±ì—”ë“œ ì „ì†¡ ì‹¤íŒ¨: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                debugLog(`ë°±ì—”ë“œ ì—°ë™ ì—ëŸ¬: ${error.message}`, 'error');
            }
        }
        
        async function logout() {
            try {
                debugLog('=== ë¡œê·¸ì•„ì›ƒ ì‹œì‘ ===');
                
                if (web3AuthInstance) {
                    await web3AuthInstance.logout();
                    debugLog('Web3Auth ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
                }
                
                hideElement('user-info');
                showElement('login-buttons');
                updateStatus('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”', 'success');
                
                debugLog('=== ë¡œê·¸ì•„ì›ƒ ì„±ê³µ ===', 'success');
            } catch (error) {
                debugLog(`ë¡œê·¸ì•„ì›ƒ ì—ëŸ¬: ${error.message}`, 'error');
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            debugLog('=== í˜ì´ì§€ ë¡œë”© ì™„ë£Œ ===');
            debugLog(`User Agent: ${navigator.userAgent}`);
            debugLog(`í˜„ì¬ ì‹œê°„: ${new Date().toISOString()}`);
            
            // CDN ë¡œë”©ì„ ì¶©ë¶„íˆ ê¸°ë‹¤ë¦° í›„ ì´ˆê¸°í™”
            setTimeout(function() {
                debugLog('ì´ˆê¸°í™” ì‹œì‘ (2ì´ˆ ì§€ì—° í›„)');
                init();
            }, 2000);
        });

        // DOM ë¡œë”© í™•ì¸
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('âœ… DOM ë¡œë”© ì™„ë£Œ', 'success');
        });

        // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬
        window.addEventListener('error', function(e) {
            debugLog(`ì „ì—­ ì—ëŸ¬: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            debugLog(`ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€: ${e.reason}`, 'error');
        });
    </script>
</body>
</html>