<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œê·¸ì¸ - ì •ì¹˜ì¸ ê³µí™”êµ­</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .login-container { background-color: #fff; padding: 50px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); text-align: center; width: 360px; }
        h1 { color: #1a1a1a; margin-bottom: 10px; font-size: 24px; font-weight: 600; }
        p { color: #666; margin-bottom: 30px; font-size: 16px; }
        .login-btn { background-color: #6a4bff; color: white; padding: 14px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; width: 100%; transition: background-color 0.2s ease-in-out; }
        .login-btn:hover { background-color: #5a3acc; }
        #status-message { margin-top: 20px; font-weight: 500; color: #333; }
    </style>
</head>
<body>
    <div id="status-message" style="display: none;"></div>
    <!-- Removed login-container as per user request -->

    <script>
        let web3auth = null;
        const clientId = "BKQkCcvERmw1_BoRMJ8frnhBV5snPap95qvfgzhfo1QLF4RHW2TwMqT1YxS_3PavJA6eOYJoO5W81-RO4J2CMNY"; 

        // ğŸ§¹ ì´ˆê¸°í™” ì‹œ ëª¨ë“  ìºì‹œ í´ë¦¬ì–´
        localStorage.clear();
        sessionStorage.clear();
        console.log("ğŸ§¹ ëª¨ë“  ìºì‹œ í´ë¦¬ì–´ë¨");
        
        // ğŸ¯ ìµœì†Œ ì„¤ì •ìœ¼ë¡œ Web3Auth ì´ˆê¸°í™”
        async function initWeb3Auth() {
            try {
                console.log("ğŸš€ ìµœì†Œ ì„¤ì •ìœ¼ë¡œ Web3Auth ì´ˆê¸°í™”...");
                
                web3auth = new window.Modal.Web3Auth({
                    clientId,
                    web3AuthNetwork: "sapphire_devnet"
                    // chainConfig ì—†ì´ ê¸°ë³¸ê°’ ì‚¬ìš©
                });

                await web3auth.initModal();
                console.log("âœ… Web3Auth ì´ˆê¸°í™” ì„±ê³µ!");
                
                document.getElementById("status-message").textContent = "ì¤€ë¹„ ì™„ë£Œ! í´ë¦­í•˜ì—¬ ë¡œê·¸ì¸";
                document.getElementById("status-message").style.display = "block";
                document.getElementById("status-message").onclick = handleLogin;
                document.getElementById("status-message").style.cursor = "pointer";
                document.getElementById("status-message").style.backgroundColor = "#4CAF50";
                document.getElementById("status-message").style.color = "white";
                document.getElementById("status-message").style.padding = "15px";
                document.getElementById("status-message").style.borderRadius = "8px";
                
            } catch (error) {
                console.error("âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
                document.getElementById("status-message").textContent = `ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`;
                document.getElementById("status-message").style.display = "block";
            }
        }
        
        // 1. initWeb3Auth í•¨ìˆ˜ë¥¼ Web3Auth ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì „ì— ì •ì˜í•©ë‹ˆë‹¤.
        async function initWeb3Auth() {
            if (isInitialized || initPromise) {
                console.log("â© Web3Auth already initialized or initializing, skipping...");
                return initPromise;
            }
            
            initPromise = (async () => {
                try {
                    console.log("ğŸš€ Starting Web3Auth initialization...");
                    isInitialized = true;
                
                // RPC ì—°ê²° í…ŒìŠ¤íŠ¸
                const workingRPC = await testRPCConnection();
                const rpcTarget = workingRPC || "https://rpc.ankr.com/eth_goerli";
                
                console.log(`ğŸ”— ì‚¬ìš©í•  RPC: ${rpcTarget}`);
                
                // 2. UMD ëª¨ë“ˆì—ì„œ ë…¸ì¶œëœ `Modal` í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                // í…ŒìŠ¤íŠ¸ë„·ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ì¶©ëŒ í•´ê²°
                const config = {
                    clientId,
                    web3AuthNetwork: "sapphire_devnet",
                    chainConfig: {
                        chainNamespace: "eip155",
                        chainId: "0x5", // Goerli Testnet (devnetê³¼ í˜¸í™˜)
                        rpcTarget: "https://rpc.ankr.com/eth_goerli",
                        displayName: "Ethereum Goerli Testnet",
                        blockExplorer: "https://goerli.etherscan.io",
                        ticker: "GoerliETH",
                        tickerName: "Goerli Ethereum",
                    },
                    // ì¶”ê°€ ì˜µì…˜ë“¤ë¡œ ì—ëŸ¬ ë°©ì§€
                    enableLogging: true,
                    storageKey: "local",
                };
                
                console.log("ğŸ“‹ Web3Auth ì„¤ì •:", config);
                web3auth = new window.Modal.Web3Auth(config);

                console.log("â³ initModal ì‹œì‘...");
                await web3auth.initModal();
                console.log("âœ… Web3Auth Initialized Successfully");
                
                document.getElementById("status-message").textContent = "ë¡œê·¸ì¸ ì¤€ë¹„ ì™„ë£Œ. í´ë¦­í•˜ì—¬ ë¡œê·¸ì¸í•˜ì„¸ìš”.";
                document.getElementById("status-message").style.display = "block";
                
                // ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ë„ë¡ ë³€ê²½
                document.getElementById("status-message").onclick = handleLogin;
                document.getElementById("status-message").style.cursor = "pointer";
                document.getElementById("status-message").style.backgroundColor = "#6a4bff";
                document.getElementById("status-message").style.color = "white";
                document.getElementById("status-message").style.padding = "10px 20px";
                document.getElementById("status-message").style.borderRadius = "8px";
                
            } catch (error) {
                console.error("âŒ Web3Auth initialization failed:", error);
                console.error("âŒ Error details:", {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                document.getElementById("status-message").textContent = `ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`;
                isInitialized = false;
            }
        }

        async function handleLogin() {
            const statusMessage = document.getElementById("status-message");
            if (!web3auth) {
                console.error("âŒ Web3Auth not initialized");
                statusMessage.textContent = "Web3Authê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
                statusMessage.style.display = "block";
                return;
            }

            try {
                console.log("ğŸ” ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ ì‹œì‘...");
                statusMessage.textContent = "ë¡œê·¸ì¸ ëª¨ë‹¬ì„ ì—´ê³  ìˆìŠµë‹ˆë‹¤...";
                statusMessage.style.display = "block";
                
                // Web3Auth connect í˜¸ì¶œ ì „ ìƒíƒœ í™•ì¸
                console.log("ğŸ“Š Web3Auth ìƒíƒœ:", {
                    ready: web3auth.ready,
                    connected: web3auth.connected,
                    provider: web3auth.provider
                });
                
                console.log("ğŸ¯ web3auth.connect() í˜¸ì¶œ ì¤‘...");
                const provider = await web3auth.connect();
                console.log("âœ… Provider ìˆ˜ì‹ :", provider);
                
                if (provider) {
                    statusMessage.textContent = "ì—°ê²° ì„±ê³µ! ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...";
                    console.log("ğŸ‘¤ getUserInfo() í˜¸ì¶œ ì¤‘...");
                    
                    const user = await web3auth.getUserInfo();
                    console.log("ğŸ“ ì‚¬ìš©ì ì •ë³´:", user);
                    
                    if (user && user.eoa) {
                        console.log(`ğŸ‰ ë¡œê·¸ì¸ ì„±ê³µ! ì£¼ì†Œ: ${user.eoa}`);
                        statusMessage.textContent = `ë¡œê·¸ì¸ ì„±ê³µ! ì£¼ì†Œ: ${user.eoa.substring(0, 6)}...${user.eoa.substring(-4)}`;
                        
                        // ë°±ì—”ë“œ ì„œë²„(í¬íŠ¸ 8080)ì— ë¡œê·¸ì¸ ìš”ì²­
                        try {
                            console.log("ğŸŒ ë°±ì—”ë“œ ì„œë²„ ë¡œê·¸ì¸ ì‹œë„...");
                            const response = await fetch("http://localhost:8080/api/auth/wallet/login", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ address: user.eoa })
                            });

                            console.log("ğŸ“¡ ë°±ì—”ë“œ ì‘ë‹µ:", response.status, response.statusText);

                            if (response.ok) {
                                statusMessage.textContent = "ë°±ì—”ë“œ ë¡œê·¸ì¸ ì„±ê³µ! ëŒ€ì‹œë³´ë“œë¡œ ì´ë™í•©ë‹ˆë‹¤.";
                                setTimeout(() => {
                                    window.location.href = "http://localhost:8080/";
                                }, 1000);
                            } else {
                                const errorText = await response.text();
                                console.error("âŒ ë°±ì—”ë“œ ë¡œê·¸ì¸ ì‹¤íŒ¨:", errorText);
                                statusMessage.textContent = `ë°±ì—”ë“œ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${errorText}`;
                            }
                        } catch (backendError) {
                            console.log("âš ï¸ ë°±ì—”ë“œ ì—°ë™ ì‹¤íŒ¨, ë¡œì»¬ í…ŒìŠ¤íŠ¸ë§Œ ì§„í–‰:", backendError);
                            setTimeout(() => {
                                alert(`ë¡œì»¬ Web3Auth í…ŒìŠ¤íŠ¸ ì„±ê³µ!\nì£¼ì†Œ: ${user.eoa}\nì´ë©”ì¼: ${user.email || 'N/A'}\nì´ë¦„: ${user.name || 'N/A'}`);
                            }, 1000);
                        }
                        
                    } else {
                        console.error("âŒ ì‚¬ìš©ì ì •ë³´ ë˜ëŠ” EOA ì—†ìŒ:", user);
                        statusMessage.textContent = "ì§€ê°‘ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                    }
                } else {
                    console.log("âš ï¸ Provider ì—†ìŒ - ì‚¬ìš©ìê°€ ì—°ê²° ì·¨ì†Œ");
                    statusMessage.textContent = "ì—°ê²°ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.";
                }
            } catch (error) {
                console.error("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
                console.error("âŒ ì˜¤ë¥˜ ìƒì„¸:", {
                    name: error.name,
                    message: error.message,
                    stack: error.stack,
                    code: error.code
                });
                
                // JSON-RPC ì—ëŸ¬ì¸ ê²½ìš° ì¶”ê°€ ì •ë³´ ì¶œë ¥
                if (error.message.includes('JSON-RPC')) {
                    console.error("ğŸ” JSON-RPC ì—ëŸ¬ ë¶„ì„:");
                    console.error("- RPC ì„œë²„ ì—°ê²° ë¬¸ì œì¼ ê°€ëŠ¥ì„±");
                    console.error("- ë„¤íŠ¸ì›Œí¬ ì„¤ì • í™•ì¸ í•„ìš”");
                    console.error("- ë°©í™”ë²½ ë˜ëŠ” CORS ë¬¸ì œ ê°€ëŠ¥ì„±");
                }
                
                statusMessage.textContent = `ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error.message}`;
                statusMessage.style.display = "block";
            }
        }
        
        
    </script>
    
    <!-- 3. ë¡œì»¬ Web3Auth íŒŒì¼ ì‚¬ìš© (CDN ë¬¸ì œ í•´ê²°) -->
    <script src="/js/web3auth-modal.umd.min.js" onload="initWeb3Auth()"></script>

</body>
</html>