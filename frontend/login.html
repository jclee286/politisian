<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인 - 정치인 공화국</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .login-container { background-color: #fff; padding: 50px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); text-align: center; width: 360px; }
        h1 { color: #1a1a1a; margin-bottom: 10px; font-size: 24px; font-weight: 600; }
        p { color: #666; margin-bottom: 30px; font-size: 16px; }
        .login-btn { background-color: #6a4bff; color: white; padding: 14px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; width: 100%; transition: background-color 0.2s ease-in-out; }
        .login-btn:hover { background-color: #5a3acc; }
        #status-message { margin-top: 20px; font-weight: 500; color: #333; }
    </style>
</head>
<body>
    <div id="status-message" style="display: none;"></div>
    <!-- Removed login-container as per user request -->

    <script>
        let web3auth = null;
        const clientId = "BKQkCcvERmw1_BoRMJ8frnhBV5snPap95qvfgzhfo1QLF4RHW2TwMqT1YxS_3PavJA6eOYJoO5W81-RO4J2CMNY"; 

        // 🧹 초기화 시 모든 캐시 클리어
        localStorage.clear();
        sessionStorage.clear();
        console.log("🧹 모든 캐시 클리어됨");
        
        // 🎯 최소 설정으로 Web3Auth 초기화
        async function initWeb3Auth() {
            try {
                console.log("🚀 최소 설정으로 Web3Auth 초기화...");
                
                web3auth = new window.Modal.Web3Auth({
                    clientId,
                    web3AuthNetwork: "sapphire_devnet"
                    // chainConfig 없이 기본값 사용
                });

                await web3auth.initModal();
                console.log("✅ Web3Auth 초기화 성공!");
                
                document.getElementById("status-message").textContent = "준비 완료! 클릭하여 로그인";
                document.getElementById("status-message").style.display = "block";
                document.getElementById("status-message").onclick = handleLogin;
                document.getElementById("status-message").style.cursor = "pointer";
                document.getElementById("status-message").style.backgroundColor = "#4CAF50";
                document.getElementById("status-message").style.color = "white";
                document.getElementById("status-message").style.padding = "15px";
                document.getElementById("status-message").style.borderRadius = "8px";
                
            } catch (error) {
                console.error("❌ 초기화 실패:", error);
                document.getElementById("status-message").textContent = `초기화 실패: ${error.message}`;
                document.getElementById("status-message").style.display = "block";
            }
        }
        
        // 1. initWeb3Auth 함수를 Web3Auth 라이브러리 로드 전에 정의합니다.
        async function initWeb3Auth() {
            if (isInitialized || initPromise) {
                console.log("⏩ Web3Auth already initialized or initializing, skipping...");
                return initPromise;
            }
            
            initPromise = (async () => {
                try {
                    console.log("🚀 Starting Web3Auth initialization...");
                    isInitialized = true;
                
                // RPC 연결 테스트
                const workingRPC = await testRPCConnection();
                const rpcTarget = workingRPC || "https://rpc.ankr.com/eth_goerli";
                
                console.log(`🔗 사용할 RPC: ${rpcTarget}`);
                
                // 2. UMD 모듈에서 노출된 `Modal` 클래스를 사용합니다.
                // 테스트넷으로 변경하여 네트워크 충돌 해결
                const config = {
                    clientId,
                    web3AuthNetwork: "sapphire_devnet",
                    chainConfig: {
                        chainNamespace: "eip155",
                        chainId: "0x5", // Goerli Testnet (devnet과 호환)
                        rpcTarget: "https://rpc.ankr.com/eth_goerli",
                        displayName: "Ethereum Goerli Testnet",
                        blockExplorer: "https://goerli.etherscan.io",
                        ticker: "GoerliETH",
                        tickerName: "Goerli Ethereum",
                    },
                    // 추가 옵션들로 에러 방지
                    enableLogging: true,
                    storageKey: "local",
                };
                
                console.log("📋 Web3Auth 설정:", config);
                web3auth = new window.Modal.Web3Auth(config);

                console.log("⏳ initModal 시작...");
                await web3auth.initModal();
                console.log("✅ Web3Auth Initialized Successfully");
                
                document.getElementById("status-message").textContent = "로그인 준비 완료. 클릭하여 로그인하세요.";
                document.getElementById("status-message").style.display = "block";
                
                // 버튼 클릭으로 로그인하도록 변경
                document.getElementById("status-message").onclick = handleLogin;
                document.getElementById("status-message").style.cursor = "pointer";
                document.getElementById("status-message").style.backgroundColor = "#6a4bff";
                document.getElementById("status-message").style.color = "white";
                document.getElementById("status-message").style.padding = "10px 20px";
                document.getElementById("status-message").style.borderRadius = "8px";
                
            } catch (error) {
                console.error("❌ Web3Auth initialization failed:", error);
                console.error("❌ Error details:", {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                document.getElementById("status-message").textContent = `초기화 실패: ${error.message}`;
                isInitialized = false;
            }
        }

        async function handleLogin() {
            const statusMessage = document.getElementById("status-message");
            if (!web3auth) {
                console.error("❌ Web3Auth not initialized");
                statusMessage.textContent = "Web3Auth가 초기화되지 않았습니다.";
                statusMessage.style.display = "block";
                return;
            }

            try {
                console.log("🔐 로그인 프로세스 시작...");
                statusMessage.textContent = "로그인 모달을 열고 있습니다...";
                statusMessage.style.display = "block";
                
                // Web3Auth connect 호출 전 상태 확인
                console.log("📊 Web3Auth 상태:", {
                    ready: web3auth.ready,
                    connected: web3auth.connected,
                    provider: web3auth.provider
                });
                
                console.log("🎯 web3auth.connect() 호출 중...");
                const provider = await web3auth.connect();
                console.log("✅ Provider 수신:", provider);
                
                if (provider) {
                    statusMessage.textContent = "연결 성공! 사용자 정보를 가져오는 중...";
                    console.log("👤 getUserInfo() 호출 중...");
                    
                    const user = await web3auth.getUserInfo();
                    console.log("📝 사용자 정보:", user);
                    
                    if (user && user.eoa) {
                        console.log(`🎉 로그인 성공! 주소: ${user.eoa}`);
                        statusMessage.textContent = `로그인 성공! 주소: ${user.eoa.substring(0, 6)}...${user.eoa.substring(-4)}`;
                        
                        // 백엔드 서버(포트 8080)에 로그인 요청
                        try {
                            console.log("🌐 백엔드 서버 로그인 시도...");
                            const response = await fetch("http://localhost:8080/api/auth/wallet/login", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ address: user.eoa })
                            });

                            console.log("📡 백엔드 응답:", response.status, response.statusText);

                            if (response.ok) {
                                statusMessage.textContent = "백엔드 로그인 성공! 대시보드로 이동합니다.";
                                setTimeout(() => {
                                    window.location.href = "http://localhost:8080/";
                                }, 1000);
                            } else {
                                const errorText = await response.text();
                                console.error("❌ 백엔드 로그인 실패:", errorText);
                                statusMessage.textContent = `백엔드 로그인 실패: ${errorText}`;
                            }
                        } catch (backendError) {
                            console.log("⚠️ 백엔드 연동 실패, 로컬 테스트만 진행:", backendError);
                            setTimeout(() => {
                                alert(`로컬 Web3Auth 테스트 성공!\n주소: ${user.eoa}\n이메일: ${user.email || 'N/A'}\n이름: ${user.name || 'N/A'}`);
                            }, 1000);
                        }
                        
                    } else {
                        console.error("❌ 사용자 정보 또는 EOA 없음:", user);
                        statusMessage.textContent = "지갑 정보를 찾을 수 없습니다.";
                    }
                } else {
                    console.log("⚠️ Provider 없음 - 사용자가 연결 취소");
                    statusMessage.textContent = "연결이 취소되었습니다.";
                }
            } catch (error) {
                console.error("❌ 로그인 실패:", error);
                console.error("❌ 오류 상세:", {
                    name: error.name,
                    message: error.message,
                    stack: error.stack,
                    code: error.code
                });
                
                // JSON-RPC 에러인 경우 추가 정보 출력
                if (error.message.includes('JSON-RPC')) {
                    console.error("🔍 JSON-RPC 에러 분석:");
                    console.error("- RPC 서버 연결 문제일 가능성");
                    console.error("- 네트워크 설정 확인 필요");
                    console.error("- 방화벽 또는 CORS 문제 가능성");
                }
                
                statusMessage.textContent = `로그인 오류: ${error.message}`;
                statusMessage.style.display = "block";
            }
        }
        
        
    </script>
    
    <!-- 3. 로컬 Web3Auth 파일 사용 (CDN 문제 해결) -->
    <script src="/js/web3auth-modal.umd.min.js" onload="initWeb3Auth()"></script>

</body>
</html>