<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ ê³µí™”êµ­ - ëŒ€ì‹œë³´ë“œ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .header h1 {
            color: #333;
        }
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex; /* Add flexbox for alignment */
            flex-direction: column; /* Stack items vertically */
        }
        .card h2 {
            color: #333;
            border-bottom: 2px solid #28a745;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .wallet-address {
            font-family: monospace;
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
        }
        .referral-container {
            display: flex;
            align-items: center;
        }
        #referral-link {
            flex-grow: 1;
            margin-right: 10px;
        }
        .copy-button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .copy-button:hover {
            background-color: #0056b3;
        }
        .balance {
            font-size: 2em;
            font-weight: bold;
            color: #28a745;
            text-align: right;
        }
        .politisian-list {
            list-style: none;
            padding: 0;
        }
        .politisian-list li {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .loading {
            color: #888;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        .button {
             padding: 10px 15px;
             color: white;
             border: none;
             border-radius: 4px;
             cursor: pointer;
        }
        .propose-button { background-color: #17a2b8; }
        .propose-button:hover { background-color: #138496; }
        .vote-button {
            margin-left: 10px;
            padding: 5px 10px;
        }
        .approve { background-color: #28a745; }
        .reject { background-color: #dc3545; }
    </style>
</head>
<body>

    <div class="header">
        <h1>ë‚˜ì˜ ê³µí™”êµ­</h1>
        <p id="welcome-message">ì‚¬ìš©ìë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!</p>
        <button id="login-button" style="display: none;">ë¡œê·¸ì¸</button>
    </div>

    <div class="dashboard-container">
        <div class="card">
            <h2>ë‚˜ì˜ ì§€ê°‘ ì •ë³´</h2>
            <p><strong>ì§€ê°‘ ì£¼ì†Œ:</strong></p>
            <div id="wallet-address" class="wallet-address loading">
                ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
        </div>
        <div class="card">
            <h2>ì¹œêµ¬ ì´ˆëŒ€ ë° ë³´ìƒ</h2>
            <p>ì¹œêµ¬ì—ê²Œ ì•„ë˜ ë§í¬ë¥¼ ê³µìœ í•˜ê³ , ì¹œêµ¬ê°€ ê°€ì…í•˜ë©´ ë³´ìƒ í¬ë ˆë”§ì„ ë°›ìŠµë‹ˆë‹¤.</p>
            <div class="referral-container" style="margin-bottom: 20px;">
                <input type="text" id="referral-link" class="wallet-address" readonly>
                <button id="copy-button" class="copy-button">ë³µì‚¬</button>
            </div>
            <p id="copy-status" style="height: 1em; color: green;"></p>
            
            <hr style="margin: 20px 0;">

            <p>ì‚¬ìš© ê°€ëŠ¥í•œ ì¶”ì²œ í¬ë ˆë”§: <strong id="referral-credits" style="font-size: 1.2em;">0</strong> ê°œ</p>
            <button id="claim-reward-button" class="button" disabled>í¬ë ˆë”§ ì‚¬ìš© (ì§€ì§€ ì •ì¹˜ì¸ ì¶”ê°€ & 100 ì½”ì¸ ë°›ê¸°)</button>
            <p id="claim-status" style="height: 1em; color: green;"></p>
        </div>
        <div class="card">
            <h2>ë‚´ê°€ ì§€ì§€í•˜ëŠ” ì •ì¹˜ì¸</h2>
            <ul id="politisian-list" class="politisian-list">
                <li class="loading">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
            </ul>
        </div>
    </div>

    <div class="dashboard-container" style="margin-top: 20px;">
        <div class="card">
            <h2>ìƒˆë¡œìš´ ì •ì¹˜ì¸ ë°œì˜</h2>
            <form id="propose-form">
                <div class="form-group">
                    <label for="name">ì´ë¦„</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="region">ì§€ì—­êµ¬</label>
                    <input type="text" id="region" required>
                </div>
                <div class="form-group">
                    <label for="party">ì†Œì†ì •ë‹¹</label>
                    <input type="text" id="party" required>
                </div>
                <button type="submit" class="button propose-button">ë°œì˜í•˜ê¸°</button>
            </form>
            <p id="propose-status" style="height: 1em; color: green;"></p>
        </div>
        <div class="card">
            <h2>ì§„í–‰ì¤‘ì¸ ë°œì˜ ëª©ë¡</h2>
            <ul id="proposals-list" class="politisian-list">
                <li class="loading">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const welcomeMessage = document.getElementById('welcome-message');
            const walletAddressElem = document.getElementById('wallet-address');
            const politisianListElem = document.getElementById('politisian-list');
            const loginButton = document.getElementById('login-button');
            const referralLinkInput = document.getElementById('referral-link');
            const copyButton = document.getElementById('copy-button');
            const copyStatus = document.getElementById('copy-status');
            const referralCreditsSpan = document.getElementById('referral-credits');
            const claimRewardButton = document.getElementById('claim-reward-button');
            const claimStatus = document.getElementById('claim-status');
            const proposalsListElem = document.getElementById('proposals-list');
            const proposeForm = document.getElementById('propose-form');
            const proposeStatus = document.getElementById('propose-status');

            console.log('ğŸ  ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ ë¡œë“œ, APIì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘...');
            console.log('ğŸª í˜„ì¬ ì¿ í‚¤:', document.cookie);
            console.log('ğŸŒ í˜„ì¬ URL:', window.location.href);

            loginButton.addEventListener('click', () => {
                window.location.href = '/'; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
            });
            
            // ëŒ€ì‹œë³´ë“œ UIë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
            function updateDashboardUI(data) {
                welcomeMessage.textContent = `${data.nickname || 'ì‚¬ìš©ì'}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
                walletAddressElem.textContent = data.wallet;
                referralLinkInput.value = `${window.location.origin}/login.html?ref=${data.wallet}`;
                
                referralCreditsSpan.textContent = data.referral_credits || 0;
                if (data.referral_credits > 0) {
                    claimRewardButton.disabled = false;
                }

                if (data.politisians && data.politisians.length > 0) {
                    politisianListElem.innerHTML = ''; // 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...' ë©”ì‹œì§€ ì‚­ì œ
                    data.politisians.forEach(p => {
                        const li = document.createElement('li');
                        li.innerHTML = `${p} <span style="float: right; color: #28a745; font-weight: normal;">100 P-COIN</span>`;
                        politisianListElem.appendChild(li);
                    });
                } else {
                    politisianListElem.innerHTML = '<li>ì§€ì§€í•˜ëŠ” ì •ì¹˜ì¸ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                }
            }

            // ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
            function fetchDashboardData(skipAuthRedirect = false) {
                console.log(`ğŸ“¡ /api/user/profile ìš”ì²­ ì‹œì‘ (skipAuthRedirect: ${skipAuthRedirect})`);
                return fetch('/api/user/profile')
                    .then(response => {
                        console.log(`ğŸ“¡ ì„œë²„ ì‘ë‹µ: ${response.status} ${response.statusText}`);
                        if (response.status === 401) {
                            console.log('ğŸ”’ 401 ì¸ì¦ ì˜¤ë¥˜ ë°œìƒ');
                            if (!skipAuthRedirect) {
                                console.log('ğŸ”„ ì•ˆì „í•œ ë¦¬ë‹¤ì´ë ‰ì…˜ ì¤€ë¹„ ì¤‘...');
                                // ì¦‰ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ì§€ ì•Šê³  ì•½ê°„ì˜ ì§€ì—° í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸
                                setTimeout(() => {
                                    console.log('ğŸšª ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜');
                                    window.location.replace('/login.html');
                                }, 1000);
                                throw new Error('ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                            } else {
                                console.log('â¸ï¸ ë¦¬ë‹¤ì´ë ‰ì…˜ ìŠ¤í‚µ, ì¬ì‹œë„ ëŒ€ê¸°...');
                                throw new Error('í”„ë¡œí•„ì´ ì•„ì§ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...');
                            }
                        }
                        if (response.status === 502) {
                            console.log('ğŸš¨ 502 Bad Gateway ì˜¤ë¥˜ - ì„œë²„ ë¬¸ì œ');
                            throw new Error('ì„œë²„ì— ì¼ì‹œì ì¸ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                        }
                        if (!response.ok) {
                            console.log(`âŒ HTTP ì˜¤ë¥˜: ${response.status}`);
                            throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${response.status}): ëŒ€ì‹œë³´ë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                        }
                        console.log('âœ… ì„±ê³µì ìœ¼ë¡œ ì‘ë‹µ ë°›ìŒ, JSON íŒŒì‹± ì¤‘...');
                        return response.json();
                    })
                    .catch(error => {
                        console.log('ğŸ”¥ fetch ì˜¤ë¥˜:', error);
                        throw error;
                    });
            }

            // ë°ì´í„°ê°€ ì™„ì „íˆ ê¸°ë¡ë  ë•Œê¹Œì§€ í´ë§í•˜ëŠ” í•¨ìˆ˜
            function pollForDashboardData(maxAttempts = 15, delay = 3000, attempt = 1) {
                console.log(`ğŸ  ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì¡°íšŒ ì‹œë„ #${attempt}/${maxAttempts}`);
                // í´ë§ ì¤‘ì—ëŠ” í•­ìƒ ì¸ì¦ ë¦¬ë‹¤ì´ë ‰ì…˜ì„ ìŠ¤í‚µ (success.htmlì—ì„œ ì´ë¯¸ ê²€ì¦ë¨)
                const skipAuthRedirect = true;
                console.log(`ğŸ”’ ì¸ì¦ ë¦¬ë‹¤ì´ë ‰ì…˜ ìŠ¤í‚µ ì—¬ë¶€: ${skipAuthRedirect}`);
                fetchDashboardData(skipAuthRedirect)
                    .then(data => {
                        console.log('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ìˆ˜ì‹ :', data);
                        updateDashboardUI(data); // ì¼ë‹¨ UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

                        // í”„ë¡œí•„ì´ ì™„ì „íˆ ìƒì„±ë˜ì—ˆëŠ”ì§€ (ì§€ê°‘ ì£¼ì†Œê°€ ìˆëŠ”ì§€) í™•ì¸í•©ë‹ˆë‹¤.
                        if (data && data.wallet && data.wallet !== 'ì£¼ì†Œ ì—†ìŒ' && data.wallet.trim() !== '') {
                            console.log('ìœ íš¨í•œ ì§€ê°‘ ì£¼ì†Œ ìˆ˜ì‹ , í´ë§ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.');
                            return; // ì„±ê³µ, í´ë§ ì¤‘ë‹¨
                        }
                        
                        if (attempt < maxAttempts) {
                            console.log('í”„ë¡œí•„ì´ ì•„ì§ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤...');
                            setTimeout(() => pollForDashboardData(maxAttempts, delay, attempt + 1), delay);
                        } else {
                            console.error(`ìµœëŒ€ ì‹œë„ íšŸìˆ˜(${maxAttempts})ì— ë„ë‹¬í–ˆì§€ë§Œ, ì™„ì „í•œ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`);
                            throw new Error('í”„ë¡œí•„ ì •ë³´ë¥¼ ì²˜ë¦¬í•˜ëŠ”ë° ì‹œê°„ì´ ë” í•„ìš”í•©ë‹ˆë‹¤. ì ì‹œ í›„ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching dashboard data:', error);
                        
                        // í”„ë¡œí•„ ì²˜ë¦¬ ì¤‘ì´ê±°ë‚˜ ì„œë²„ ë¬¸ì œì¸ ê²½ìš° ê³„ì† ì¬ì‹œë„
                        if ((error.message.includes('í”„ë¡œí•„ì´ ì•„ì§ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤') || 
                             error.message.includes('502') || 
                             error.message.includes('ì„œë²„ì— ì¼ì‹œì ì¸ ë¬¸ì œ')) && 
                            attempt < maxAttempts) {
                            console.log('í”„ë¡œí•„ ì²˜ë¦¬ ì¤‘ ë˜ëŠ” ì„œë²„ ë¬¸ì œ, ê³„ì† ì¬ì‹œë„í•©ë‹ˆë‹¤...');
                            setTimeout(() => pollForDashboardData(maxAttempts, delay, attempt + 1), delay);
                            return;
                        }
                        
                        // ìµœì¢… ì˜¤ë¥˜ ì²˜ë¦¬
                        welcomeMessage.textContent = 'ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                        walletAddressElem.textContent = 'ì˜¤ë¥˜';
                        politisianListElem.innerHTML = `<li>${error.message}</li>`;
                        loginButton.style.display = 'block';
                    });
            }

            // ì•ˆì „í•œ ì´ˆê¸° ë¡œë“œ í•¨ìˆ˜
            function safeInitialLoad(maxAttempts = 3, attempt = 1) {
                console.log(`ğŸ”„ ì•ˆì „í•œ ì´ˆê¸° ë¡œë“œ ì‹œë„ #${attempt}/${maxAttempts}`);
                
                // ë¨¼ì € í•œ ë²ˆë§Œ ì‹œë„í•´ì„œ ìƒíƒœ í™•ì¸
                fetchDashboardData(true) // skipAuthRedirect = true
                    .then(data => {
                        console.log('âœ… ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì„±ê³µ:', data);
                        updateDashboardUI(data);
                        
                        // ë°ì´í„°ê°€ ì™„ì „í•œì§€ í™•ì¸
                        if (data && data.wallet && data.wallet !== 'ì£¼ì†Œ ì—†ìŒ' && data.wallet.trim() !== '') {
                            console.log('ğŸ‰ ì™„ì „í•œ í”„ë¡œí•„ ë°ì´í„° í™•ì¸ë¨');
                            // í”„ë¡œí•„ ë°ì´í„°ê°€ ì™„ì „í•œ ê²½ìš°ì—ë§Œ ì œì•ˆ ëª©ë¡ ë¡œë“œ
                            setTimeout(() => {
                                console.log('ğŸ“‹ ì œì•ˆ ëª©ë¡ ë¡œë“œ ì‹œì‘');
                                fetchProposals();
                            }, 1000);
                        } else {
                            console.log('âš ï¸ ë¶ˆì™„ì „í•œ ë°ì´í„°, í´ë§ ì‹œì‘');
                            // ë¶ˆì™„ì „í•œ ë°ì´í„°ì¸ ê²½ìš°ì—ë§Œ í´ë§ ì‹œì‘
                            setTimeout(() => pollForDashboardData(), 2000);
                        }
                    })
                    .catch(error => {
                        console.error(`âŒ ì´ˆê¸° ë¡œë“œ ì‹¤íŒ¨ (ì‹œë„ ${attempt}):`, error);
                        
                        if (attempt < maxAttempts) {
                            console.log(`â³ 3ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„... (${attempt + 1}/${maxAttempts})`);
                            setTimeout(() => {
                                safeInitialLoad(maxAttempts, attempt + 1);
                            }, 3000);
                        } else {
                            console.error('ğŸš¨ ì´ˆê¸° ë¡œë“œ ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ë„ë‹¬');
                            welcomeMessage.textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.';
                            walletAddressElem.textContent = 'ì˜¤ë¥˜';
                            politisianListElem.innerHTML = '<li>ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>';
                            loginButton.style.display = 'block';
                        }
                    });
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•ˆì „í•œ ë°©ì‹ìœ¼ë¡œ ë°ì´í„° ë¡œë“œ ì‹œì‘
            console.log('ğŸ  ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ ë¡œë“œë¨');
            
            // success.htmlì—ì„œ ì˜¨ ê²½ìš°ë¥¼ ê³ ë ¤í•˜ì—¬ ì´ˆê¸° ë¡œë“œ ì‹œë„
            setTimeout(() => {
                safeInitialLoad();
            }, 1000); // 1ì´ˆ ëŒ€ê¸° í›„ ì‹œì‘

            copyButton.addEventListener('click', function() {
                referralLinkInput.select();
                document.execCommand('copy');
                copyStatus.textContent = 'ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!';
                setTimeout(() => {
                    copyStatus.textContent = '';
                }, 2000);
            });

            claimRewardButton.addEventListener('click', function() {
                claimStatus.textContent = 'ë³´ìƒ ìš”ì²­ ì¤‘...';
                claimRewardButton.disabled = true;

                fetch('/api/rewards/claim', { // ì°¸ê³ : ì´ APIëŠ” ì•„ì§ ë°±ì—”ë“œì— êµ¬í˜„ í•„ìš”
                    method: 'POST',
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text) });
                    }
                    return response.text();
                })
                .then(data => {
                    claimStatus.textContent = 'ë³´ìƒì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.';
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                })
                .catch(error => {
                    console.error('ë³´ìƒ ìš”ì²­ ì‹¤íŒ¨:', error);
                    claimStatus.textContent = `ì˜¤ë¥˜: ${error.message}`;
                    claimRewardButton.disabled = false;
                });
            });

            proposeForm.addEventListener('submit', function(event) {
                event.preventDefault();
                proposeStatus.textContent = 'ë°œì˜ ìš”ì²­ ì¤‘...';

                const politisianData = {
                    name: document.getElementById('name').value,
                    region: document.getElementById('region').value,
                    party: document.getElementById('party').value,
                };

                fetch('/api/politisian/propose', { // ìˆ˜ì •: ì˜¬ë°”ë¥¸ ë°œì˜ API ì—”ë“œí¬ì¸íŠ¸
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(politisianData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || 'ë°œì˜ ì‹¤íŒ¨') });
                    }
                    return response.text();
                })
                .then(data => {
                    proposeStatus.textContent = 'ë°œì˜ ì„±ê³µ! ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.';
                    proposeForm.reset();
                    setTimeout(() => {
                        proposeStatus.textContent = '';
                        fetchProposals();
                    }, 2000);
                })
                .catch(error => {
                    proposeStatus.textContent = `ì˜¤ë¥˜: ${error.message}`;
                });
            });

            function fetchProposals() {
                proposalsListElem.innerHTML = '<li class="loading">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>';
                fetch('/api/politisian/list') // ìˆ˜ì •: ì˜¬ë°”ë¥¸ ì œì•ˆ ëª©ë¡ API ì—”ë“œí¬ì¸íŠ¸
                    .then(response => {
                        if (response.status === 401) {
                            // ì•ˆì „í•œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì¦‰ì‹œ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ)
                            console.log('ğŸ”’ ì œì•ˆ ëª©ë¡ì—ì„œ 401 ì˜¤ë¥˜, ì•ˆì „í•œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì¤€ë¹„');
                            setTimeout(() => {
                                console.log('ğŸšª ì œì•ˆ ëª©ë¡ 401 ì˜¤ë¥˜ë¡œ ì¸í•œ ë¡œê·¸ì¸ í˜ì´ì§€ ë¦¬ë‹¤ì´ë ‰íŠ¸');
                                window.location.replace('/login.html');
                            }, 2000);
                            throw new Error('ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                        }
                        if (!response.ok) {
                            throw new Error('ì œì•ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                        return response.json();
                    })
                    .then(proposals => {
                        proposalsListElem.innerHTML = '';
                        if (Object.keys(proposals).length === 0) {
                            proposalsListElem.innerHTML = '<li>ì§„í–‰ì¤‘ì¸ ë°œì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                            return;
                        }
                        for (const id in proposals) {
                            const p = proposals[id];
                            const li = document.createElement('li');
                            li.innerHTML = `
                                <strong>${p.politisian.name}</strong> (ì§€ì—­: ${p.politisian.region}, ì •ë‹¹: ${p.politisian.party})
                                <br>
                                <span>ì°¬ì„±: ${p.yes_votes} / ë°˜ëŒ€: ${p.no_votes}</span>
                                <button class="button vote-button approve" data-id="${p.id}" data-vote="true">ì°¬ì„±</button>
                                <button class="button vote-button reject" data-id="${p.id}" data-vote="false">ë°˜ëŒ€</button>
                            `;
                            proposalsListElem.appendChild(li);
                        }
                    })
                    .catch(error => {
                        proposalsListElem.innerHTML = `<li>${error.message}</li>`;
                    });
            }

            proposalsListElem.addEventListener('click', function(event) {
                if (event.target.matches('.vote-button')) {
                    const proposalId = event.target.dataset.id;
                    const vote = event.target.dataset.vote === 'true';
                    
                    event.target.parentElement.querySelectorAll('.vote-button').forEach(btn => btn.disabled = true);

                    fetch(`/api/proposals/${proposalId}/vote`, { // ì°¸ê³ : ì´ APIëŠ” ì•„ì§ ë°±ì—”ë“œì— êµ¬í˜„ í•„ìš”
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ vote: vote })
                    })
                    .then(response => {
                         if (!response.ok) {
                            return response.text().then(text => { throw new Error(text || 'íˆ¬í‘œ ì‹¤íŒ¨') });
                        }
                        return response.text();
                    })
                    .then(data => {
                        alert('íˆ¬í‘œê°€ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤. ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
                        fetchProposals();
                    })
                    .catch(error => {
                        alert(`ì˜¤ë¥˜: ${error.message}`);
                        event.target.parentElement.querySelectorAll('.vote-button').forEach(btn => btn.disabled = false);
                    });
                }
            });
        });
    </script>
</body>
</html> 