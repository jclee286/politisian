<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나의 공화국 - 대시보드</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .header h1 {
            color: #333;
        }
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex; /* Add flexbox for alignment */
            flex-direction: column; /* Stack items vertically */
        }
        .card h2 {
            color: #333;
            border-bottom: 2px solid #28a745;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .wallet-address {
            font-family: monospace;
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
        }
        .referral-container {
            display: flex;
            align-items: center;
        }
        #referral-link {
            flex-grow: 1;
            margin-right: 10px;
        }
        .copy-button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .copy-button:hover {
            background-color: #0056b3;
        }
        .balance {
            font-size: 2em;
            font-weight: bold;
            color: #28a745;
            text-align: right;
        }
        .politician-list {
            list-style: none;
            padding: 0;
        }
        .politician-list li {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .loading {
            color: #888;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        .button {
             padding: 10px 15px;
             color: white;
             border: none;
             border-radius: 4px;
             cursor: pointer;
        }
        .propose-button { background-color: #17a2b8; }
        .propose-button:hover { background-color: #138496; }
        .vote-button {
            margin-left: 10px;
            padding: 5px 10px;
        }
        .approve { background-color: #28a745; }
        .reject { background-color: #dc3545; }
    </style>
</head>
<body>

    <div class="header">
        <h1>나의 공화국</h1>
        <p id="welcome-message">사용자님, 환영합니다!</p>
        <button id="login-button" style="display: none;">로그인</button>
    </div>

    <div class="dashboard-container">
        <div class="card">
            <h2>나의 지갑 정보</h2>
            <p><strong>지갑 주소:</strong></p>
            <div id="wallet-address" class="wallet-address loading">
                불러오는 중...
            </div>
        </div>
        <div class="card">
            <h2>보유 코인</h2>
            <div id="balance" class="balance loading">
                -
            </div>
        </div>
        <div class="card">
            <h2>내가 지지하는 정치인</h2>
            <ul id="politicians-list" class="politician-list">
                <li class="loading">목록을 불러오는 중...</li>
            </ul>
        </div>
        <div class="card">
            <h2>나의 추천인 링크</h2>
            <p>친구에게 이 링크를 공유하고 보상을 받으세요!</p>
            <div class="referral-container">
                <input type="text" id="referral-link" class="wallet-address" readonly>
                <button id="copy-button" class="copy-button">복사</button>
            </div>
            <p id="copy-status" style="height: 1em; color: green;"></p>
        </div>

        <div class="card">
            <h2>추천 보상</h2>
            <p>친구를 초대하고 받은 크레딧으로 추가 보상을 받으세요!</p>
            <p>사용 가능한 추천 크레딧: <strong id="referral-credits" style="font-size: 1.2em;">0</strong> 개</p>
            <button id="claim-reward-button" class="button" disabled>크레딧 사용 (100 코인 받기)</button>
            <p id="claim-status" style="height: 1em; color: green;"></p>
        </div>
    </div>

    <div class="dashboard-container" style="margin-top: 20px;">
        <div class="card">
            <h2>새로운 정치인 발의</h2>
            <form id="propose-form">
                <div class="form-group">
                    <label for="name">이름</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="region">지역구</label>
                    <input type="text" id="region" required>
                </div>
                <div class="form-group">
                    <label for="party">소속정당</label>
                    <input type="text" id="party" required>
                </div>
                <button type="submit" class="button propose-button">발의하기</button>
            </form>
            <p id="propose-status" style="height: 1em; color: green;"></p>
        </div>
        <div class="card">
            <h2>진행중인 발의 목록</h2>
            <ul id="proposals-list" class="politician-list">
                <li class="loading">목록을 불러오는 중...</li>
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const welcomeMessage = document.getElementById('welcome-message');
            const walletAddressElem = document.getElementById('wallet-address');
            const balanceElem = document.getElementById('balance');
            const politiciansListElem = document.getElementById('politicians-list');
            const loginButton = document.getElementById('login-button');
            const referralLinkInput = document.getElementById('referral-link');
            const copyButton = document.getElementById('copy-button');
            const copyStatus = document.getElementById('copy-status');
            const referralCreditsSpan = document.getElementById('referral-credits');
            const claimRewardButton = document.getElementById('claim-reward-button');
            const claimStatus = document.getElementById('claim-status');
            const proposalsListElem = document.getElementById('proposals-list');
            const proposeForm = document.getElementById('propose-form');
            const proposeStatus = document.getElementById('propose-status');

            console.log('대시보드 페이지 로드, API에서 데이터 가져오는 중...');

            loginButton.addEventListener('click', () => {
                window.location.href = '/'; // 로그인 페이지로 이동
            });

            fetch('/api/me/dashboard')
                .then(response => {
                    if (response.status === 401) {
                         // 인증되지 않은 경우, 로그인 버튼을 보여주고 에러 메시지를 표시
                        loginButton.style.display = 'block';
                        throw new Error('인증이 필요합니다. 다시 로그인해주세요.');
                    }
                    if (!response.ok) {
                        throw new Error('대시보드 정보를 불러오는데 실패했습니다. 다시 로그인해주세요.');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('대시보드 데이터 수신:', data);
                    welcomeMessage.textContent = `${data.nickname || '사용자'}님, 환영합니다!`;
                    walletAddressElem.textContent = data.wallet;
                    balanceElem.textContent = `${data.balance} P-COIN`;
                    referralLinkInput.value = `${window.location.origin}/login.html?ref=${data.wallet}`;
                    
                    referralCreditsSpan.textContent = data.referral_credits || 0;
                    if (data.referral_credits > 0) {
                        claimRewardButton.disabled = false;
                    }

                    if (data.politicians && data.politicians.length > 0) {
                        politiciansListElem.innerHTML = ''; // '불러오는 중...' 메시지 삭제
                        data.politicians.forEach(p => {
                            const li = document.createElement('li');
                            li.textContent = p;
                            politiciansListElem.appendChild(li);
                        });
                    } else {
                        politiciansListElem.innerHTML = '<li>지지하는 정치인이 없습니다.</li>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching dashboard data:', error);
                    // 에러 발생 시, 사용자에게 안내 메시지 표시
                    welcomeMessage.textContent = '정보를 불러올 수 없습니다. 로그인이 필요할 수 있습니다.';
                    walletAddressElem.textContent = '오류';
                    balanceElem.textContent = '-';
                    politiciansListElem.innerHTML = `<li>${error.message}</li>`;
                    // 401 에러가 아니더라도 로그인 버튼을 보여줘서 재시도 유도
                    loginButton.style.display = 'block';
                });

            fetchProposals();

            copyButton.addEventListener('click', function() {
                referralLinkInput.select();
                document.execCommand('copy');
                copyStatus.textContent = '복사되었습니다!';
                setTimeout(() => {
                    copyStatus.textContent = '';
                }, 2000);
            });

            claimRewardButton.addEventListener('click', function() {
                claimStatus.textContent = '보상 요청 중...';
                claimRewardButton.disabled = true;

                fetch('/api/rewards/claim', {
                    method: 'POST',
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text) });
                    }
                    return response.text();
                })
                .then(data => {
                    claimStatus.textContent = '보상이 지급되었습니다! 페이지를 새로고침합니다.';
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                })
                .catch(error => {
                    console.error('보상 요청 실패:', error);
                    claimStatus.textContent = `오류: ${error.message}`;
                    claimRewardButton.disabled = false;
                });
            });

            proposeForm.addEventListener('submit', function(event) {
                event.preventDefault();
                proposeStatus.textContent = '발의 요청 중...';

                const politicianData = {
                    name: document.getElementById('name').value,
                    region: document.getElementById('region').value,
                    party: document.getElementById('party').value,
                };

                fetch('/api/politicians/propose', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(politicianData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || '발의 실패') });
                    }
                    return response.text();
                })
                .then(data => {
                    proposeStatus.textContent = '발의 성공! 목록을 새로고침합니다.';
                    proposeForm.reset();
                    setTimeout(() => {
                        proposeStatus.textContent = '';
                        fetchProposals();
                    }, 2000);
                })
                .catch(error => {
                    proposeStatus.textContent = `오류: ${error.message}`;
                });
            });

            function fetchProposals() {
                proposalsListElem.innerHTML = '<li class="loading">목록을 불러오는 중...</li>';
                fetch('/api/proposals')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('제안 목록을 불러오는데 실패했습니다.');
                        }
                        return response.json();
                    })
                    .then(proposals => {
                        proposalsListElem.innerHTML = '';
                        if (Object.keys(proposals).length === 0) {
                            proposalsListElem.innerHTML = '<li>진행중인 발의가 없습니다.</li>';
                            return;
                        }
                        for (const id in proposals) {
                            const p = proposals[id];
                            const li = document.createElement('li');
                            li.innerHTML = `
                                <strong>${p.politician.name}</strong> (지역: ${p.politician.region}, 정당: ${p.politician.party})
                                <br>
                                <span>찬성: ${p.yes_votes} / 반대: ${p.no_votes}</span>
                                <button class="button vote-button approve" data-id="${p.id}" data-vote="true">찬성</button>
                                <button class="button vote-button reject" data-id="${p.id}" data-vote="false">반대</button>
                            `;
                            proposalsListElem.appendChild(li);
                        }
                    })
                    .catch(error => {
                        proposalsListElem.innerHTML = `<li>${error.message}</li>`;
                    });
            }

            proposalsListElem.addEventListener('click', function(event) {
                if (event.target.matches('.vote-button')) {
                    const proposalId = event.target.dataset.id;
                    const vote = event.target.dataset.vote === 'true';
                    
                    event.target.parentElement.querySelectorAll('.vote-button').forEach(btn => btn.disabled = true);

                    fetch(`/api/proposals/${proposalId}/vote`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ vote: vote })
                    })
                    .then(response => {
                         if (!response.ok) {
                            return response.text().then(text => { throw new Error(text || '투표 실패') });
                        }
                        return response.text();
                    })
                    .then(data => {
                        alert('투표가 반영되었습니다. 목록을 새로고침합니다.');
                        fetchProposals();
                    })
                    .catch(error => {
                        alert(`오류: ${error.message}`);
                        event.target.parentElement.querySelectorAll('.vote-button').forEach(btn => btn.disabled = false);
                    });
                }
            });
        });
    </script>
</body>
</html> 