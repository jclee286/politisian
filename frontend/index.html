<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ë‚˜ì˜ ê³µí™”êµ­ - ëŒ€ì‹œë³´ë“œ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            display: none;
        }
        .header h1 {
            color: #333;
        }
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        .card h2 {
            color: #333;
            border-bottom: 2px solid #28a745;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .wallet-address {
            font-family: monospace;
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
        }
        .referral-container {
            display: flex;
            align-items: center;
        }
        #referral-link {
            flex-grow: 1;
            margin-right: 10px;
        }
        .copy-button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .copy-button:hover {
            background-color: #0056b3;
        }
        .politisian-list {
            list-style: none;
            padding: 0;
        }
        .politisian-list li {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .loading {
            color: #888;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        .button {
             padding: 10px 15px;
             color: white;
             border: none;
             border-radius: 4px;
             cursor: pointer;
        }
        .propose-button { background-color: #17a2b8; }
        .propose-button:hover { background-color: #138496; }
        .vote-button {
            margin-left: 10px;
            padding: 5px 10px;
        }
        .approve { background-color: #28a745; }
        .reject { background-color: #dc3545; }
        .error-message {
            color: red;
            margin: 10px 0;
        }
        .success-message {
            color: green;
            margin: 10px 0;
        }
    </style>
</head>
<body>

    <div class="header">
        <!-- í—¤ë” ìˆ¨ê¹€ -->
        <button id="login-button" style="display: none;">ë¡œê·¸ì¸</button>
    </div>

    <div class="dashboard-container">
        <div class="card">
            <h2>ë‚˜ì˜ ì§€ê°‘ ì •ë³´</h2>
            <p><strong>ì§€ê°‘ ì£¼ì†Œ:</strong></p>
            <div id="wallet-address" class="wallet-address loading">
                ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
        </div>
        <div class="card">
            <h2>ì¹œêµ¬ ì´ˆëŒ€ ë° ë³´ìƒ</h2>
            <p>ì¹œêµ¬ì—ê²Œ ì•„ë˜ ë§í¬ë¥¼ ê³µìœ í•˜ê³ , ì¹œêµ¬ê°€ ê°€ì…í•˜ë©´ ë³´ìƒ í¬ë ˆë”§ì„ ë°›ìŠµë‹ˆë‹¤.</p>
            <div class="referral-container" style="margin-bottom: 20px;">
                <input type="text" id="referral-link" class="wallet-address" readonly>
                <button id="copy-button" class="copy-button">ë³µì‚¬</button>
            </div>
            <p id="copy-status" style="height: 1em; color: green;"></p>
            
            <hr style="margin: 20px 0;">

            <p>ì‚¬ìš© ê°€ëŠ¥í•œ ì¶”ì²œ í¬ë ˆë”§: <strong id="referral-credits" style="font-size: 1.2em;">0</strong> ê°œ</p>
            <button id="claim-reward-button" class="button" disabled>í¬ë ˆë”§ ì‚¬ìš© (ì§€ì§€ ì •ì¹˜ì¸ ì¶”ê°€ & 100 ì½”ì¸ ë°›ê¸°)</button>
            <p id="claim-status" style="height: 1em; color: green;"></p>
        </div>
        <div class="card">
            <h2>ë‚´ê°€ ì§€ì§€í•˜ëŠ” ì •ì¹˜ì¸</h2>
            <ul id="politisian-list" class="politisian-list">
                <li class="loading">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
            </ul>
        </div>
        <div class="card">
            <h2>ë“±ë¡ëœ ì •ì¹˜ì¸ ëª©ë¡</h2>
            <p>íˆ¬í‘œë¥¼ í†µí•´ ìŠ¹ì¸ëœ ëª¨ë“  ì •ì¹˜ì¸ë“¤ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <div class="search-container" style="margin-bottom: 15px;">
                <input type="text" id="search-politicians" placeholder="ì •ì¹˜ì¸ ì´ë¦„, ì§€ì—­êµ¬, ì •ë‹¹ìœ¼ë¡œ ê²€ìƒ‰..." 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
            </div>
            <ul id="registered-politicians-list" class="politisian-list">
                <li class="loading">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
            </ul>
        </div>
    </div>

    <div class="dashboard-container" style="margin-top: 20px;">
        <div class="card">
            <h2>ìƒˆë¡œìš´ ì •ì¹˜ì¸ ë°œì˜</h2>
            <form id="propose-form">
                <div class="form-group">
                    <label for="name">ì´ë¦„</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="region">ì§€ì—­êµ¬ (ì„ íƒì‚¬í•­)</label>
                    <input type="text" id="region" placeholder="ì˜ˆ: ì„œìš¸ ê°•ë‚¨êµ¬ ê°‘">
                </div>
                <div class="form-group">
                    <label for="party">ì†Œì†ì •ë‹¹</label>
                    <input type="text" id="party" required>
                </div>
                <div class="form-group">
                    <label for="intro-url">ì†Œê°œ URL (ì„ íƒì‚¬í•­)</label>
                    <input type="url" id="intro-url" placeholder="https://example.com/politician-profile">
                </div>
                <button type="submit" class="button propose-button">ë°œì˜í•˜ê¸°</button>
            </form>
            <p id="propose-status" style="height: 1em; color: green;"></p>
        </div>
        <div class="card">
            <h2>ì§„í–‰ì¤‘ì¸ ë°œì˜ ëª©ë¡</h2>
            <ul id="proposals-list" class="politisian-list">
                <li class="loading">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ  ì™„ì „í•œ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ ë¡œë“œë¨ (v2.0)');
            
            // ì™„ì „íˆ ì•ˆì „í•œ ìš”ì†Œ ì°¸ì¡°
            const welcomeMessage = null; // ì™„ì „ ì œê±°
            const walletAddressElem = document.getElementById('wallet-address');
            const politisianListElem = document.getElementById('politisian-list');
            const loginButton = document.getElementById('login-button');
            const referralLinkInput = document.getElementById('referral-link');
            const copyButton = document.getElementById('copy-button');
            const copyStatus = document.getElementById('copy-status');
            const referralCreditsSpan = document.getElementById('referral-credits');
            const claimRewardButton = document.getElementById('claim-reward-button');
            const claimStatus = document.getElementById('claim-status');
            const proposalsListElem = document.getElementById('proposals-list');
            const registeredPoliticiansListElem = document.getElementById('registered-politicians-list');
            const searchPoliticiansInput = document.getElementById('search-politicians');
            const proposeForm = document.getElementById('propose-form');
            const proposeStatus = document.getElementById('propose-status');
            
            // ì „ì—­ ì •ì¹˜ì¸ ë°ì´í„° ì €ì¥
            let allPoliticiansData = {};

            console.log('ğŸª í˜„ì¬ ì¿ í‚¤:', document.cookie);

            // ì•ˆì „í•œ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (ë¬´í•œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë°©ì§€)
            function loadUserProfile() {
                console.log('ğŸ‘¤ ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ ì‹œì‘');
                
                fetch('/api/user/profile')
                    .then(response => {
                        console.log('ğŸ“¡ í”„ë¡œí•„ API ì‘ë‹µ:', response.status);
                        
                        if (response.status === 401) {
                            console.log('ğŸ”’ 401 ì¸ì¦ ì˜¤ë¥˜ - ì„¸ì…˜ ì •ë³´ë¡œ ëŒ€ì²´');
                            loadSessionInfo();
                            return null;
                        }
                        
                        if (!response.ok) {
                            console.log('âŒ í”„ë¡œí•„ API ì‹¤íŒ¨, ì„¸ì…˜ ì •ë³´ë¡œ ëŒ€ì²´');
                            loadSessionInfo();
                            return null;
                        }
                        
                        return response.json();
                    })
                    .then(data => {
                        if (data) {
                            console.log('âœ… í”„ë¡œí•„ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', data);
                            walletAddressElem.textContent = data.wallet || data.walletAddress || 'ì§€ê°‘ ì£¼ì†Œ ì—†ìŒ';
                            
                            // ë°±ì—… ë°ì´í„° ì €ì¥
                            saveBackupData(data.wallet || data.walletAddress, {
                                email: data.email,
                                address: data.address
                            });
                            
                            updateDashboardUI(data);
                            loadProposals(); // í”„ë¡œí•„ ë¡œë“œ ì„±ê³µ í›„ì—ë§Œ ì œì•ˆ ëª©ë¡ ë¡œë“œ
                            loadRegisteredPoliticians(); // ë“±ë¡ëœ ì •ì¹˜ì¸ ëª©ë¡ ë¡œë“œ
                        }
                    })
                    .catch(error => {
                        console.error('âŒ í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', error);
                        loadSessionInfo(); // ì‹¤íŒ¨ ì‹œ ì„¸ì…˜ ì •ë³´ë¡œ ëŒ€ì²´
                    });
            }

            // ì„¸ì…˜ ì •ë³´ë¡œ ëŒ€ì²´ ë¡œë“œ
            function loadSessionInfo() {
                console.log('ğŸ”‘ ì„¸ì…˜ ì •ë³´ë¡œ ëŒ€ì²´ ë¡œë“œ ì‹œë„');
                
                fetch('/api/user/session-info')
                    .then(response => {
                        console.log('ğŸ“¡ ì„¸ì…˜ API ì‘ë‹µ ìƒíƒœ:', response.status);
                        if (response.ok) {
                            return response.json();
                        }
                        throw new Error(`ì„¸ì…˜ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ${response.status}`);
                    })
                    .then(sessionData => {
                        console.log('âœ… ì„¸ì…˜ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', sessionData);
                        
                        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                        walletAddressElem.textContent = sessionData.walletAddress || 'ì§€ê°‘ ì£¼ì†Œ ì—†ìŒ';
                        
                        // ë°±ì—… ë°ì´í„° ì €ì¥
                        saveBackupData(sessionData.walletAddress, {
                            name: sessionData.name,
                            email: sessionData.email,
                            userId: sessionData.userId
                        });
                        
                        // ì„¸ì…˜ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê¸°ë³¸ UI ì—…ë°ì´íŠ¸
                        // welcomeMessage.textContent = `${sessionData.name}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
                        referralLinkInput.value = `${window.location.origin}/login.html?ref=${sessionData.walletAddress}`;
                        politisianListElem.innerHTML = '<li>í”„ë¡œí•„ ì •ë³´ë¥¼ ì™„ì „íˆ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>';
                        
                        // ì„¸ì…˜ ì •ë³´ë¡œë„ ì œì•ˆ ëª©ë¡ ì‹œë„
                        setTimeout(() => {
                            loadProposals();
                            loadRegisteredPoliticians();
                        }, 2000);
                    })
                    .catch(error => {
                        console.error('âŒ ì„¸ì…˜ ì •ë³´ë„ ë¡œë“œ ì‹¤íŒ¨:', error);
                        handleCompleteFailure();
                    });
            }

            // ì™„ì „í•œ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë³µêµ¬ ì „ëµ
            function handleCompleteFailure() {
                console.log('ğŸš¨ ì™„ì „í•œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ - ë³µêµ¬ ì‹œë„');
                
                // 1ë‹¨ê³„: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°±ì—… ë°ì´í„° í™•ì¸
                const backupWallet = localStorage.getItem('backup_wallet_address');
                const backupUserInfo = localStorage.getItem('backup_user_info');
                
                if (backupWallet) {
                    console.log('ğŸ’¾ ë¡œì»¬ ë°±ì—…ì—ì„œ ì§€ê°‘ ì£¼ì†Œ ë³µêµ¬');
                    walletAddressElem.textContent = backupWallet;
                    referralLinkInput.value = `${window.location.origin}/login.html?ref=${backupWallet}`;
                    
                    if (backupUserInfo) {
                        try {
                            const userInfo = JSON.parse(backupUserInfo);
                            // welcomeMessage.textContent = `${userInfo.name}ë‹˜ (ë³µêµ¬ëœ ì„¸ì…˜)`;
                        } catch (e) {
                            console.log('ë°±ì—… ì‚¬ìš©ì ì •ë³´ íŒŒì‹± ì‹¤íŒ¨');
                        }
                    }
                    
                    showRecoveryMessage();
                    return;
                }
                
                // 2ë‹¨ê³„: ì„¸ì…˜ ë§Œë£Œë¡œ íŒë‹¨í•˜ê³  ì¬ë¡œê·¸ì¸ ìœ ë„
                walletAddressElem.textContent = 'ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤';
                politisianListElem.innerHTML = '<li style="color: #e74c3c;">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</li>';
                
                // ì¬ë¡œê·¸ì¸ ë²„íŠ¼ í‘œì‹œ
                showReloginPrompt();
            }
            
            // ë³µêµ¬ ë©”ì‹œì§€ í‘œì‹œ
            function showRecoveryMessage() {
                const recoveryMsg = document.createElement('div');
                recoveryMsg.style.cssText = `
                    position: fixed; top: 20px; right: 20px; 
                    background: #f39c12; color: white; 
                    padding: 15px 20px; border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 1000; font-size: 14px;
                `;
                recoveryMsg.innerHTML = `
                    âš ï¸ ë°±ì—… ë°ì´í„°ì—ì„œ ë³µêµ¬ë¨<br>
                    <small>ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ë¡œê·¸ì¸ì„ ê¶Œì¥í•©ë‹ˆë‹¤</small>
                `;
                document.body.appendChild(recoveryMsg);
                
                setTimeout(() => recoveryMsg.remove(), 10000);
            }
            
            // ì¬ë¡œê·¸ì¸ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
            function showReloginPrompt() {
                const reloginDiv = document.createElement('div');
                reloginDiv.style.cssText = `
                    position: fixed; top: 50%; left: 50%; 
                    transform: translate(-50%, -50%);
                    background: white; padding: 30px; 
                    border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                    text-align: center; z-index: 2000;
                    border: 2px solid #e74c3c;
                `;
                reloginDiv.innerHTML = `
                    <h3 style="color: #e74c3c; margin-top: 0;">ğŸ”’ ì„¸ì…˜ ë§Œë£Œ</h3>
                    <p>ì•ˆì „ì„ ìœ„í•´ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”</p>
                    <button onclick="window.location.href='/login.html'" 
                            style="background: #e74c3c; color: white; border: none; 
                                   padding: 12px 24px; border-radius: 6px; 
                                   cursor: pointer; font-size: 16px;">
                        ë‹¤ì‹œ ë¡œê·¸ì¸
                    </button>
                    <br><br>
                    <button onclick="this.parentElement.remove()" 
                            style="background: #95a5a6; color: white; border: none; 
                                   padding: 8px 16px; border-radius: 4px; 
                                   cursor: pointer; font-size: 14px;">
                        ë‚˜ì¤‘ì—
                    </button>
                `;
                
                // ë°°ê²½ ì˜¤ë²„ë ˆì´
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); z-index: 1500;
                `;
                
                document.body.appendChild(overlay);
                document.body.appendChild(reloginDiv);
                
                // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
                overlay.onclick = () => {
                    overlay.remove();
                    reloginDiv.remove();
                };
            }
            
            // ë°±ì—… ë°ì´í„° ì €ì¥ (ë¡œê·¸ì¸ ì„±ê³µ ì‹œ í˜¸ì¶œ)
            function saveBackupData(walletAddress, userInfo) {
                localStorage.setItem('backup_wallet_address', walletAddress);
                localStorage.setItem('backup_user_info', JSON.stringify(userInfo));
                localStorage.setItem('backup_timestamp', Date.now().toString());
            }

            // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateDashboardUI(data) {
                try {
                    console.log('ğŸ¨ UI ì—…ë°ì´íŠ¸ ì‹œì‘');
                    
                    // ì•ˆì „í•œ ìš”ì†Œ ì ‘ê·¼
                    if (walletAddressElem) {
                        walletAddressElem.textContent = data.wallet || 'ì£¼ì†Œ ì—†ìŒ';
                    }
                    
                    if (referralLinkInput) {
                        referralLinkInput.value = `${window.location.origin}/login.html?ref=${data.wallet}`;
                    }
                    
                    if (referralCreditsSpan) {
                        referralCreditsSpan.textContent = data.referral_credits || 0;
                    }
                    
                    if (claimRewardButton && data.referral_credits > 0) {
                        claimRewardButton.disabled = false;
                    }

                    if (politisianListElem) {
                        if (data.politisians && data.politisians.length > 0) {
                            politisianListElem.innerHTML = '';
                            data.politisians.forEach(p => {
                                const li = document.createElement('li');
                                li.innerHTML = `${p} <span style="float: right; color: #28a745; font-weight: normal;">100 P-COIN</span>`;
                                politisianListElem.appendChild(li);
                            });
                        } else {
                            politisianListElem.innerHTML = '<li>ì§€ì§€í•˜ëŠ” ì •ì¹˜ì¸ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                        }
                    }
                    
                    console.log('âœ… UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                } catch (error) {
                    console.error('âŒ updateDashboardUI ì˜¤ë¥˜:', error);
                }
            }

            // ì œì•ˆ ëª©ë¡ ë¡œë“œ (ì•ˆì „í•œ ë°©ì‹)
            function loadProposals() {
                console.log('ğŸ“‹ ì œì•ˆ ëª©ë¡ ë¡œë“œ ì‹œì‘');
                
                fetch('/api/politisian/list')
                    .then(response => {
                        if (response.status === 401) {
                            console.log('ğŸ”’ ì œì•ˆ ëª©ë¡ì—ì„œ 401 ì˜¤ë¥˜ - ìŠ¤í‚µ');
                            proposalsListElem.innerHTML = '<li>ì œì•ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</li>';
                            return null;
                        }
                        if (!response.ok) {
                            throw new Error('ì œì•ˆ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
                        }
                        return response.json();
                    })
                    .then(proposals => {
                        if (proposals) {
                            console.log('âœ… ì œì•ˆ ëª©ë¡ ë¡œë“œ ì„±ê³µ:', proposals);
                            console.log('proposals íƒ€ì…:', typeof proposals, 'keys:', Object.keys(proposals));
                            proposalsListElem.innerHTML = '';
                            
                            // proposalsê°€ ê°ì²´ì¸ì§€ í™•ì¸
                            if (typeof proposals !== 'object' || proposals === null) {
                                proposalsListElem.innerHTML = '<li>ì œì•ˆ ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜</li>';
                                return;
                            }
                            
                            if (Object.keys(proposals).length === 0) {
                                proposalsListElem.innerHTML = '<li>ì§„í–‰ì¤‘ì¸ ë°œì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                                return;
                            }
                            
                            for (const id in proposals) {
                                const p = proposals[id];
                                console.log('ì œì•ˆ ë°ì´í„°:', id, p);
                                
                                // ì•ˆì „í•œ ë°ì´í„° ê²€ì¦
                                if (!p || typeof p !== 'object') {
                                    console.warn('Invalid proposal object:', p);
                                    continue;
                                }
                                
                                if (!p.politician || typeof p.politician !== 'object') {
                                    console.warn('Invalid politician data:', p.politician);
                                    continue;
                                }
                                
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <strong>${p.politician.name || 'ì´ë¦„ ì—†ìŒ'}</strong> (ì§€ì—­: ${p.politician.region || 'ë¯¸ì§€ì •'}, ì •ë‹¹: ${p.politician.party || 'ë¯¸ì§€ì •'})
                                    ${p.politician.intro_url ? '<br><a href="' + p.politician.intro_url + '" target="_blank">ì†Œê°œ í˜ì´ì§€</a>' : ''}
                                    <br>
                                    <span>ì°¬ì„±: ${p.yes_votes || 0} / ë°˜ëŒ€: ${p.no_votes || 0}</span>
                                    <button class="button vote-button approve" data-id="${p.id}" data-vote="true">ì°¬ì„±</button>
                                    <button class="button vote-button reject" data-id="${p.id}" data-vote="false">ë°˜ëŒ€</button>
                                `;
                                proposalsListElem.appendChild(li);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('âŒ ì œì•ˆ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                        proposalsListElem.innerHTML = `<li>ì œì•ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</li>`;
                    });
            }

            // ë“±ë¡ëœ ì •ì¹˜ì¸ ëª©ë¡ ë¡œë“œ
            function loadRegisteredPoliticians() {
                console.log('ğŸ›ï¸ ë“±ë¡ëœ ì •ì¹˜ì¸ ëª©ë¡ ë¡œë“œ ì‹œì‘');
                
                fetch('/api/politisian/registered')
                    .then(response => {
                        if (response.status === 401) {
                            console.log('ğŸ”’ ë“±ë¡ëœ ì •ì¹˜ì¸ ëª©ë¡ì—ì„œ 401 ì˜¤ë¥˜ - ìŠ¤í‚µ');
                            registeredPoliticiansListElem.innerHTML = '<li>ë“±ë¡ëœ ì •ì¹˜ì¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</li>';
                            return null;
                        }
                        if (!response.ok) {
                            throw new Error('ë“±ë¡ëœ ì •ì¹˜ì¸ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
                        }
                        return response.json();
                    })
                    .then(politicians => {
                        if (politicians) {
                            console.log('âœ… ë“±ë¡ëœ ì •ì¹˜ì¸ ëª©ë¡ ë¡œë“œ ì„±ê³µ:', politicians);
                            
                            // ì „ì—­ ë³€ìˆ˜ì— ë°ì´í„° ì €ì¥
                            allPoliticiansData = politicians;
                            
                            // ëª©ë¡ í‘œì‹œ
                            displayPoliticians(politicians);
                        }
                    })
                    .catch(error => {
                        console.error('âŒ ë“±ë¡ëœ ì •ì¹˜ì¸ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                        registeredPoliticiansListElem.innerHTML = `<li>ë“±ë¡ëœ ì •ì¹˜ì¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</li>`;
                    });
            }

            // ì •ì¹˜ì¸ ëª©ë¡ í‘œì‹œ í•¨ìˆ˜
            function displayPoliticians(politicians) {
                registeredPoliticiansListElem.innerHTML = '';
                
                if (Object.keys(politicians).length === 0) {
                    registeredPoliticiansListElem.innerHTML = '<li>ë“±ë¡ëœ ì •ì¹˜ì¸ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                    return;
                }
                
                for (const name in politicians) {
                    const politician = politicians[name];
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <strong>${politician.name || name}</strong>
                        <br>
                        <span style="color: #666;">ì§€ì—­: ${politician.region || 'ë¯¸ì§€ì •'} | ì •ë‹¹: ${politician.party || 'ë¯¸ì§€ì •'}</span>
                        ${politician.intro_url ? '<br><a href="' + politician.intro_url + '" target="_blank" style="color: #007bff;">ì†Œê°œ í˜ì´ì§€ â†’</a>' : ''}
                    `;
                    registeredPoliticiansListElem.appendChild(li);
                }
            }

            // ì •ì¹˜ì¸ ê²€ìƒ‰ í•¨ìˆ˜
            function searchPoliticians(searchTerm) {
                if (!searchTerm.trim()) {
                    displayPoliticians(allPoliticiansData);
                    return;
                }
                
                const filteredPoliticians = {};
                searchTerm = searchTerm.toLowerCase();
                
                for (const name in allPoliticiansData) {
                    const politician = allPoliticiansData[name];
                    const searchableText = `${politician.name || name} ${politician.region || ''} ${politician.party || ''}`.toLowerCase();
                    
                    if (searchableText.includes(searchTerm)) {
                        filteredPoliticians[name] = politician;
                    }
                }
                
                displayPoliticians(filteredPoliticians);
            }

            // ì˜¤ë¥˜ í‘œì‹œ í•¨ìˆ˜
            function showError(message) {
                console.error('ğŸš¨ ì˜¤ë¥˜:', message);
                // welcomeMessageëŠ” ì œê±°ëœ ìš”ì†Œì´ë¯€ë¡œ ìŠ¤í‚µ
                walletAddressElem.textContent = 'ì˜¤ë¥˜';
                politisianListElem.innerHTML = `<li class="error-message">${message}</li>`;
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
            loginButton.addEventListener('click', () => {
                window.location.href = '/login.html';
            });

            // ì •ì¹˜ì¸ ê²€ìƒ‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            searchPoliticiansInput.addEventListener('input', function(e) {
                searchPoliticians(e.target.value);
            });

            copyButton.addEventListener('click', function() {
                referralLinkInput.select();
                document.execCommand('copy');
                copyStatus.textContent = 'ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!';
                setTimeout(() => {
                    copyStatus.textContent = '';
                }, 2000);
            });

            claimRewardButton.addEventListener('click', function() {
                claimStatus.textContent = 'ë³´ìƒ ìš”ì²­ ì¤‘...';
                claimRewardButton.disabled = true;

                fetch('/api/rewards/claim', {
                    method: 'POST',
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text) });
                    }
                    return response.text();
                })
                .then(data => {
                    claimStatus.textContent = 'ë³´ìƒì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.';
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                })
                .catch(error => {
                    console.error('ë³´ìƒ ìš”ì²­ ì‹¤íŒ¨:', error);
                    claimStatus.textContent = `ì˜¤ë¥˜: ${error.message}`;
                    claimRewardButton.disabled = false;
                });
            });

            proposeForm.addEventListener('submit', function(event) {
                event.preventDefault();
                proposeStatus.textContent = 'ë°œì˜ ìš”ì²­ ì¤‘...';

                const politisianData = {
                    name: document.getElementById('name').value,
                    region: document.getElementById('region').value,
                    party: document.getElementById('party').value,
                    introUrl: document.getElementById('intro-url').value,
                };

                fetch('/api/politisian/propose', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(politisianData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || 'ë°œì˜ ì‹¤íŒ¨') });
                    }
                    return response.text();
                })
                .then(data => {
                    proposeStatus.textContent = 'ë°œì˜ ì„±ê³µ! ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.';
                    proposeForm.reset();
                    setTimeout(() => {
                        proposeStatus.textContent = '';
                        loadProposals();
                        loadRegisteredPoliticians();
                    }, 2000);
                })
                .catch(error => {
                    proposeStatus.textContent = `ì˜¤ë¥˜: ${error.message}`;
                });
            });

            proposalsListElem.addEventListener('click', function(event) {
                if (event.target.matches('.vote-button')) {
                    const proposalId = event.target.dataset.id;
                    const vote = event.target.dataset.vote === 'true';
                    
                    event.target.parentElement.querySelectorAll('.vote-button').forEach(btn => btn.disabled = true);

                    fetch(`/api/proposals/${proposalId}/vote`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ vote: vote })
                    })
                    .then(response => {
                         if (!response.ok) {
                            return response.text().then(text => { throw new Error(text || 'íˆ¬í‘œ ì‹¤íŒ¨') });
                        }
                        return response.text();
                    })
                    .then(data => {
                        // ì•Œë¦¼ì°½ ì—†ì´ ë°”ë¡œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        loadProposals();
                        loadRegisteredPoliticians();
                        
                        // íˆ¬í‘œ ë²„íŠ¼ ë¹„í™œì„±í™” ë° ìƒíƒœ í‘œì‹œ
                        const allVoteButtons = event.target.parentElement.querySelectorAll('.vote-button');
                        allVoteButtons.forEach(btn => {
                            btn.disabled = true;
                            btn.style.opacity = '0.5';
                        });
                        
                        // íˆ¬í‘œ ì™„ë£Œ í‘œì‹œ
                        const statusSpan = document.createElement('span');
                        statusSpan.textContent = 'íˆ¬í‘œ ì™„ë£Œ âœ“';
                        statusSpan.style.color = '#28a745';
                        statusSpan.style.fontWeight = 'bold';
                        statusSpan.style.marginLeft = '10px';
                        event.target.parentElement.appendChild(statusSpan);
                    })
                    .catch(error => {
                        alert(`ì˜¤ë¥˜: ${error.message}`);
                        event.target.parentElement.querySelectorAll('.vote-button').forEach(btn => btn.disabled = false);
                    });
                }
            });

            // ì•ˆì „í•œ ë°ì´í„° ë¡œë“œ ì‹œì‘ (5ì´ˆ ì§€ì—°ìœ¼ë¡œ ë¬´í•œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë°©ì§€)
            setTimeout(() => {
                console.log('ğŸš€ 5ì´ˆ í›„ ì•ˆì „í•œ ë°ì´í„° ë¡œë“œ ì‹œì‘');
                loadUserProfile();
            }, 5000);
        });
    </script>
</body>
</html>