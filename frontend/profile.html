<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡œí•„ ì„¤ì • - ì •ì¹˜ì¸ ê³µí™”êµ­</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { background-color: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
        h1 { color: #333; margin-bottom: 10px; }
        p { color: #666; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 5px; color: #333; font-weight: bold; }
        input[type="text"], select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        input[type="radio"] { margin-right: 10px; }
        .gender-group label { display: inline-block; margin-right: 20px; }
        button { background-color: #28a745; color: white; padding: 15px 20px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; }
        button:hover { background-color: #218838; }
        .status-message { margin-top: 20px; font-weight: bold; word-wrap: break-word; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1>í”„ë¡œí•„ ì„¤ì •</h1>
        <p>ì²˜ìŒ ì˜¤ì…¨êµ°ìš”! ì•ìœ¼ë¡œ í™œë™í•˜ì‹œë ¤ë©´ í”„ë¡œí•„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
        <form id="profileForm">
            <div class="form-group">
                <label for="walletAddress">ë‚˜ì˜ ì§€ê°‘ ì£¼ì†Œ</label>
                <input type="text" id="walletAddress" name="walletAddress" readonly value="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...">
            </div>
            <div class="form-group">
                <label for="nickname">ë‹‰ë„¤ì„</label>
                <input type="text" id="nickname" name="nickname" required>
            </div>
            <div class="form-group">
                <label for="country">êµ­ê°€</label>
                <select id="country" name="country">
                    <option value="KR">ëŒ€í•œë¯¼êµ­</option>
                    <option value="US">ë¯¸êµ­</option>
                    <option value="JP">ì¼ë³¸</option>
                    <option value="CN">ì¤‘êµ­</option>
                </select>
            </div>
            <div class="form-group gender-group">
                <label>ì„±ë³„</label>
                <label><input type="radio" name="gender" value="male" checked> ë‚¨ì„±</label>
                <label><input type="radio" name="gender" value="female"> ì—¬ì„±</label>
            </div>
            <div class="form-group">
                <label for="birthYear">ì¶œìƒ ì—°ë„</label>
                <select id="birthYear" name="birthYear"></select>
            </div>
            <hr style="margin: 30px 0;">
            <div class="form-group">
                <label>ì§€ì§€ ì •ì¹˜ì¸ ì„ íƒ</label>
                <p>ë§¤ì¼ ìë™ìœ¼ë¡œ 100 P-COINì´ ì§€ê¸‰ë©ë‹ˆë‹¤. (ìµœëŒ€ 3ëª…)</p>
                <div>
                    <label for="politisian1">ì •ì¹˜ì¸ 1:</label>
                    <select id="politisian1" name="politisian1"></select>
                </div>
                <div>
                    <label for="politisian2">ì •ì¹˜ì¸ 2:</label>
                    <select id="politisian2" name="politisian2"></select>
                </div>
                <div>
                    <label for="politisian3">ì •ì¹˜ì¸ 3:</label>
                    <select id="politisian3" name="politisian3"></select>
                </div>
            </div>

            <button type="submit">í”„ë¡œí•„ ì €ì¥</button>
        </form>
        <div id="statusMessage" class="status-message"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const birthYearSelect = document.getElementById('birthYear');
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= 1940; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                birthYearSelect.appendChild(option);
            }

            fetch('/api/user/profile')
                .then(response => {
                    if (response.status === 404) {
                        return null; // ìƒˆ ì‚¬ìš©ìëŠ” í”„ë¡œí•„ì´ ì—†ìœ¼ë¯€ë¡œ null ë°˜í™˜
                    }
                    if (!response.ok) {
                        if (response.status === 401) window.location.href = '/login.html';
                        throw new Error('ì„œë²„ì—ì„œ í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.wallet) {
                        document.getElementById('walletAddress').value = data.wallet;
                    } else {
                        // ìƒˆ ì‚¬ìš©ìì´ê±°ë‚˜ ì§€ê°‘ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°, ì„¸ì…˜ì—ì„œ ì§€ê°‘ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                        loadWalletFromSession();
                    }
                })
                .catch(error => {
                    document.getElementById('statusMessage').textContent = error.message;
                    document.getElementById('statusMessage').className = 'status-message error';
                });

            // 1. ì „ì²´ ì •ì¹˜ì¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì™€ì„œ select ì˜µì…˜ì„ ì±„ì›ë‹ˆë‹¤.
            fetch('/api/politisian/list')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ì •ì¹˜ì¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    return response.json();
                })
                .then(politisianData => {
                    console.log('ì •ì¹˜ì¸ ë°ì´í„°:', politisianData); // ë””ë²„ê¹…ìš©
                    const politisianSelectors = [
                        document.getElementById('politisian1'),
                        document.getElementById('politisian2'),
                        document.getElementById('politisian3')
                    ];
                    politisianSelectors.forEach(select => {
                        select.innerHTML = '<option value="">ì„ íƒ ì•ˆí•¨</option>'; // ê¸°ë³¸ ì˜µì…˜
                        
                        // ì •ì¹˜ì¸ ë°ì´í„°ê°€ ê°ì²´ í˜•íƒœì¸ ê²½ìš°
                        if (politisianData && typeof politisianData === 'object') {
                            for (const [politicianId, politician] of Object.entries(politisianData)) {
                                const option = document.createElement('option');
                                option.value = politicianId;
                                option.textContent = `${politician.name} (${politician.party}, ${politician.region})`;
                                select.appendChild(option);
                            }
                        }
                    });

                    // 2. í˜„ì¬ ì‚¬ìš©ìì˜ í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™€ì„œ í¼ì— ì±„ì›ë‹ˆë‹¤.
                    return fetch('/api/user/profile');
                })
                .then(response => {
                    if (response.status === 404) {
                        return null; // ìƒˆ ì‚¬ìš©ìëŠ” í”„ë¡œí•„ì´ ì—†ìœ¼ë¯€ë¡œ null ë°˜í™˜
                    }
                    if (!response.ok) {
                        throw new Error('ì‚¬ìš©ì í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    return response.json();
                })
                .then(profile => {
                    if (!profile) return; // ìƒˆ ì‚¬ìš©ìì˜ ê²½ìš° ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ

                    document.getElementById('nickname').value = profile.nickname || '';
                    document.getElementById('country').value = profile.country || 'KR';
                    if (profile.gender) {
                        const genderRadio = document.querySelector(`input[name="gender"][value="${profile.gender}"]`);
                        if (genderRadio) genderRadio.checked = true;
                    }
                    if (profile.birthYear) {
                        document.getElementById('birthYear').value = profile.birthYear;
                    }
                    
                    // ì‚¬ìš©ìê°€ ì§€ì§€í•˜ëŠ” ì •ì¹˜ì¸ì„ select ìš”ì†Œì— ë°˜ì˜í•©ë‹ˆë‹¤.
                    if (profile.politisian && profile.politisian.length > 0) {
                        document.getElementById('politisian1').value = profile.politisian[0] || '';
                        document.getElementById('politisian2').value = profile.politisian[1] || '';
                        document.getElementById('politisian3').value = profile.politisian[2] || '';
                    }
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    alert(error.message);
                });
            
            // Get referrer from URL
            const urlParams = new URLSearchParams(window.location.search);
            const referrer = urlParams.get('ref');
            if (referrer) {
                const referrerInput = document.createElement('input');
                referrerInput.type = 'hidden';
                referrerInput.id = 'referrer';
                referrerInput.value = referrer;
                document.getElementById('profileForm').appendChild(referrerInput);
            }
        });

        document.getElementById('profileForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            console.log('ğŸ’¾ í”„ë¡œí•„ ì €ì¥ ì‹œì‘'); // ë””ë²„ê¹…
            
            const form = event.target;
            const submitButton = form.querySelector('button[type="submit"]');
            const statusMessage = document.getElementById('statusMessage');
            
            // ì¤‘ë³µ í´ë¦­ ë°©ì§€
            if (submitButton.disabled) {
                console.log('ğŸš« ì´ë¯¸ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤. ì¤‘ë³µ í´ë¦­ ë°©ì§€');
                return;
            }
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            submitButton.disabled = true;
            submitButton.textContent = 'ì €ì¥ ì¤‘...';
            
            statusMessage.textContent = 'í”„ë¡œí•„ì„ ì €ì¥í•˜ëŠ” ì¤‘...';
            statusMessage.className = 'status-message';

            // URLSearchParams ì •ì˜ ì¶”ê°€
            const urlParams = new URLSearchParams(window.location.search);

            const selectedPolitisian = [
                document.getElementById('politisian1').value,
                document.getElementById('politisian2').value,
                document.getElementById('politisian3').value
            ].filter(Boolean); // ì„ íƒ ì•ˆí•œ ê²ƒ (ë¹ˆ ë¬¸ìì—´)ì€ ì œì™¸

            console.log('ì„ íƒëœ ì •ì¹˜ì¸ë“¤:', selectedPolitisian); // ë””ë²„ê¹…

            const profileData = {
                nickname: document.getElementById('nickname').value,
                country: document.getElementById('country').value,
                gender: document.querySelector('input[name="gender"]:checked').value,
                birthYear: parseInt(document.getElementById('birthYear').value, 10),
                politisians: selectedPolitisian, // ë°±ì—”ë“œì™€ ë§ì¶”ê¸° ìœ„í•´ "politisians"ë¡œ ìˆ˜ì •
                referrer: urlParams.get('ref') || null
            };
            
            console.log('ğŸ’¾ ì „ì†¡í•  í”„ë¡œí•„ ë°ì´í„°:', profileData); // ë””ë²„ê¹…

            // ### 'ì§„ì‹¤ì„ ë¹„ì¶”ëŠ” ê±°ìš¸' ìˆ˜ì • ì§€ì  ###
            fetch('/api/profile/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(profileData)
            })
            .then(response => {
                console.log('ğŸŒ ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText); // ë””ë²„ê¹…
                if (!response.ok) {
                    // ì„œë²„ê°€ ë³´ë‚´ì£¼ëŠ” í…ìŠ¤íŠ¸ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
                    return response.text().then(text => { 
                        console.log('âŒ ì„œë²„ ì—ëŸ¬ ì‘ë‹µ:', text); // ë””ë²„ê¹…
                        // ì„œë²„ê°€ í…ìŠ¤íŠ¸ë¥¼ ë³´ë‚´ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ê¸°ë³¸ ë©”ì‹œì§€
                        throw new Error(text || 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.') 
                    });
                }
                return response.text();
            })
            .then(data => {
                console.log('âœ… í”„ë¡œí•„ ì €ì¥ ì„±ê³µ:', data); // ë””ë²„ê¹…
                statusMessage.textContent = "í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ë¸”ë¡ì²´ì¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!";
                statusMessage.className = 'status-message success';
                form.querySelector('button').disabled = true;
                
                console.log('âœ… í”„ë¡œí•„ ì €ì¥ ì™„ë£Œ, ì„±ê³µ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...');
                console.log('ğŸ”„ ë¬´í•œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë°©ì§€ë¥¼ ìœ„í•´ ì„±ê³µ í˜ì´ì§€ë¥¼ ê±°ì¹©ë‹ˆë‹¤...');
                setTimeout(() => {
                    console.log('ğŸš€ ì„±ê³µ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...');
                    window.location.href = '/success.html';
                }, 3000); // 3ì´ˆ í›„ ì„±ê³µ í˜ì´ì§€ë¡œ
            })
            .catch(error => {
                console.log('âŒ í”„ë¡œí•„ ì €ì¥ ì‹¤íŒ¨:', error); // ë””ë²„ê¹…
                // error.messageëŠ” ìœ„ì—ì„œ throwí•œ ì„œë²„ì˜ ì‹¤ì œ ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ ë©ë‹ˆë‹¤.
                statusMessage.textContent = 'ì €ì¥ ì‹¤íŒ¨: ' + error.message;
                statusMessage.className = 'status-message error';
                
                // ì‹¤íŒ¨ ì‹œ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                submitButton.disabled = false;
                submitButton.textContent = 'í”„ë¡œí•„ ì‘ì„±';
            });
        });

        // ì„¸ì…˜ì—ì„œ ì§€ê°‘ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        function loadWalletFromSession() {
            fetch('/api/user/session-info')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('ì„¸ì…˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                })
                .then(sessionData => {
                    if (sessionData && sessionData.walletAddress) {
                        document.getElementById('walletAddress').value = sessionData.walletAddress;
                    } else {
                        document.getElementById('walletAddress').value = 'ì§€ê°‘ ìƒì„± ì¤‘...';
                        // ì§€ê°‘ ì •ë³´ê°€ ì—†ë‹¤ë©´ ìƒˆë¡œ ìƒì„±
                        generateWallet();
                    }
                })
                .catch(error => {
                    console.log('ì„¸ì…˜ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                    document.getElementById('walletAddress').value = 'ì§€ê°‘ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨';
                });
        }

        // ì§€ê°‘ ìƒì„± í•¨ìˆ˜ (ë°±ì—…ìš©)
        function generateWallet() {
            fetch('/api/auth/generate-wallet', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('ì§€ê°‘ ìƒì„± ì‹¤íŒ¨');
            })
            .then(data => {
                if (data && data.walletAddress) {
                    document.getElementById('walletAddress').value = data.walletAddress;
                }
            })
            .catch(error => {
                console.log('ì§€ê°‘ ìƒì„± ì‹¤íŒ¨:', error);
                document.getElementById('walletAddress').value = 'ì§€ê°‘ ìƒì„± ì‹¤íŒ¨';
            });
        }
    </script>
</body>
</html>
