<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나의 공화국 - 프로필 저장 완료</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .success-container {
            background: white;
            color: #333;
            padding: 60px 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        .success-icon {
            font-size: 80px;
            margin-bottom: 20px;
            color: #4CAF50;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2em;
        }
        .countdown {
            font-size: 3em;
            font-weight: bold;
            color: #4CAF50;
            margin: 30px 0;
        }
        .message {
            color: #666;
            margin: 20px 0;
            line-height: 1.6;
            font-size: 1.1em;
        }
        .progress-ring {
            width: 100px;
            height: 100px;
            margin: 20px auto;
        }
        .progress-ring circle {
            stroke: #4CAF50;
            stroke-width: 4;
            fill: transparent;
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transform-origin: 50% 50%;
            transform: rotate(-90deg);
            animation: countdown 15s linear forwards;
        }
        @keyframes countdown {
            to {
                stroke-dashoffset: 0;
            }
        }
    </style>
</head>
<body>
    <div class="success-container">
        <div class="success-icon">🎉</div>
        <h1>프로필 저장 완료!</h1>
        
        <svg class="progress-ring">
            <circle cx="50" cy="50" r="45" />
        </svg>
        
        <div class="countdown" id="countdown">15</div>
        
        <div class="message">
            블록체인에 프로필이 성공적으로 저장되었습니다!<br>
            <strong>15초 후</strong> 자동으로 대시보드로 이동합니다.
        </div>
    </div>

    <script>
        let timeLeft = 15;
        const countdownEl = document.getElementById('countdown');
        
        // 카운트다운 업데이트
        const timer = setInterval(() => {
            timeLeft--;
            countdownEl.textContent = timeLeft;
            
            console.log(`⏰ 대시보드 이동까지 ${timeLeft}초 남음`);
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                countdownEl.textContent = '이동중...';
                
                console.log('🚀 대시보드로 이동 시작');
                
                // 세션과 프로필이 모두 준비될 때까지 확인
                checkSessionAndProfile();
            }
        }, 1000);
        
        // 세션과 프로필 상태를 체크하는 함수
        function checkSessionAndProfile(maxAttempts = 10, attempt = 1) {
            console.log(`🔍 세션 및 프로필 체크 시도 #${attempt}/${maxAttempts}`);
            
            // 먼저 세션 체크
            fetch('/api/user/session-info')
                .then(response => {
                    console.log('📋 세션 체크 응답:', response.status);
                    if (!response.ok) {
                        throw new Error(`세션 체크 실패: ${response.status}`);
                    }
                    return response.json();
                })
                .then(sessionData => {
                    console.log('✅ 세션 데이터:', sessionData);
                    
                    // 세션이 유효하면 프로필도 체크
                    return fetch('/api/user/profile');
                })
                .then(response => {
                    console.log('📄 프로필 체크 응답:', response.status);
                    if (response.ok) {
                        console.log('🎉 세션과 프로필이 모두 준비됨, 간단한 대시보드로 이동 (디버깅용)');
                        setTimeout(() => {
                            // 일단 간단한 대시보드로 이동해서 문제 격리
                            window.location.replace('/dashboard-simple.html');
                        }, 500);
                    } else if (response.status === 401) {
                        throw new Error('프로필 인증 실패');
                    } else {
                        throw new Error(`프로필 체크 실패: ${response.status}`);
                    }
                })
                .catch(error => {
                    console.error(`❌ 체크 실패 (시도 ${attempt}):`, error);
                    
                    if (attempt < maxAttempts) {
                        console.log(`⏳ 2초 후 다시 시도... (${attempt + 1}/${maxAttempts})`);
                        setTimeout(() => {
                            checkSessionAndProfile(maxAttempts, attempt + 1);
                        }, 2000);
                    } else {
                        console.error('🚨 최대 시도 횟수 도달, 로그인 페이지로 이동');
                        window.location.replace('/login.html');
                    }
                });
        }
        
        console.log('✅ 프로필 저장 완료 페이지 로드됨');
        console.log('🍪 현재 쿠키:', document.cookie);
    </script>
</body>
</html>